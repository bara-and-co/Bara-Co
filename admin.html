<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mis Productos Â· Bara & Co</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --bg:      #f7f6f3;
      --surface: #ffffff;
      --border:  #e8e4dd;
      --text:    #1a1a17;
      --muted:   #8a8680;
      --accent:  #c9a96e;
      --adk:     #a07e48;
      --green:   #2d8a5e;
      --red:     #c0392b;
      --serif:   'Cormorant Garamond', serif;
      --sans:    'DM Sans', sans-serif;
      --ease:    cubic-bezier(.16,1,.3,1);
      --shadow:  0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
      --radius:  8px;
    }
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body { background:var(--bg); color:var(--text); font-family:var(--sans); font-size:15px; line-height:1.6; -webkit-font-smoothing:antialiased; }
    img { display:block; }

    /* TOPBAR */
    .topbar {
      background:var(--surface); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:100;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 32px; height:68px;
    }
    .topbar-left { display:flex; align-items:center; gap:14px; }
    .topbar-logo { font-family:var(--serif); font-size:22px; font-weight:500; }
    .topbar-tag  { font-size:10px; letter-spacing:.15em; text-transform:uppercase; color:var(--accent); background:rgba(201,169,110,.1); padding:3px 9px; border-radius:20px; }
    .topbar-right { display:flex; align-items:center; gap:10px; }

    /* BOTONES */
    .btn {
      display:inline-flex; align-items:center; gap:7px;
      padding:10px 20px; border:none; cursor:pointer;
      font-family:var(--sans); font-size:13px; font-weight:500;
      border-radius:var(--radius); transition:all .2s; white-space:nowrap;
    }
    .btn-primary { background:var(--accent); color:#fff; }
    .btn-primary:hover { background:var(--adk); transform:translateY(-1px); box-shadow:0 4px 12px rgba(201,169,110,.35); }
    .btn-ghost { background:var(--surface); color:var(--text); border:1px solid var(--border); }
    .btn-ghost:hover { background:var(--bg); }
    .btn-danger { background:rgba(192,57,43,.08); color:var(--red); border:1px solid rgba(192,57,43,.2); }
    .btn-danger:hover { background:rgba(192,57,43,.15); }
    .btn-sm { padding:7px 14px; font-size:12px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; transform:none !important; }

    /* PAGE */
    .page { max-width:1060px; margin:0 auto; padding:32px 24px; }

    /* SAVE BANNER */
    .save-banner {
      background:linear-gradient(135deg,#1a1a17,#2d2d28);
      color:#fff; border-radius:var(--radius); padding:18px 24px;
      margin-bottom:28px; display:none;
      align-items:center; justify-content:space-between; gap:16px;
      box-shadow:var(--shadow);
    }
    .save-banner.show { display:flex; }
    .save-banner-txt strong { color:var(--accent); }
    .save-banner-txt small { color:rgba(255,255,255,.5); font-size:12px; display:block; margin-top:2px; }

    /* TOOLBAR */
    .toolbar { display:flex; align-items:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .search-box {
      display:flex; align-items:center; gap:8px;
      background:var(--surface); border:1.5px solid var(--border); border-radius:var(--radius);
      padding:9px 14px; flex:1; min-width:180px; max-width:280px; transition:border-color .2s;
    }
    .search-box:focus-within { border-color:var(--accent); }
    .search-box i { color:var(--muted); font-size:13px; }
    .search-box input { background:none; border:none; outline:none; color:var(--text); font-family:var(--sans); font-size:14px; width:100%; }
    .search-box input::placeholder { color:var(--muted); }
    .cat-tabs { display:flex; gap:6px; flex-wrap:wrap; }
    .cat-tab {
      padding:7px 14px; border-radius:20px; font-size:12px; font-weight:500;
      border:1px solid var(--border); background:var(--surface); color:var(--muted);
      cursor:pointer; transition:all .2s;
    }
    .cat-tab:hover { border-color:var(--accent); color:var(--accent); }
    .cat-tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }

    /* GRID */
    .prod-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:16px; }

    /* CARD */
    .prod-card {
      background:var(--surface); border-radius:var(--radius); border:1px solid var(--border);
      overflow:hidden; transition:all .25s var(--ease); position:relative;
    }
    .prod-card:hover { box-shadow:var(--shadow); transform:translateY(-2px); }
    .prod-card.inactive { opacity:.55; }
    .prod-card.inactive .prod-img { filter:grayscale(.7); }

    .prod-img { aspect-ratio:3/4; overflow:hidden; background:#f0ede8; position:relative; }
    .prod-img img { width:100%; height:100%; object-fit:cover; transition:transform .5s var(--ease); }
    .prod-card:hover .prod-img img { transform:scale(1.04); }

    .cat-badge {
      position:absolute; top:10px; left:10px; z-index:2;
      font-size:8px; font-weight:600; letter-spacing:.1em; text-transform:uppercase;
      padding:3px 8px; border-radius:20px;
    }
    .badge-new { background:var(--accent); color:#fff; }
    .badge-hom { background:#3d6bce; color:#fff; }
    .badge-muj { background:#c0586b; color:#fff; }
    .badge-acc { background:#4a9668; color:#fff; }
    .disc-badge {
      position:absolute; top:10px; right:10px; z-index:2;
      background:var(--red); color:#fff; font-size:9px; font-weight:700; padding:3px 7px; border-radius:4px;
    }

    .prod-overlay {
      position:absolute; inset:0; background:rgba(0,0,0,.42);
      display:flex; align-items:center; justify-content:center; gap:10px;
      opacity:0; transition:opacity .25s;
    }
    .prod-card:hover .prod-overlay { opacity:1; }
    .ov-btn {
      background:#fff; color:var(--text); border:none; cursor:pointer;
      width:40px; height:40px; border-radius:50%; display:grid; place-items:center;
      font-size:14px; transition:all .2s;
    }
    .ov-btn:hover { background:var(--accent); color:#fff; transform:scale(1.1); }
    .ov-btn.del:hover { background:var(--red); }

    .prod-info { padding:14px; }
    .prod-name { font-weight:500; font-size:14px; line-height:1.3; margin-bottom:6px; }
    .prod-price { display:flex; align-items:baseline; gap:6px; }
    .price-main { font-family:var(--serif); font-size:18px; color:var(--accent); }
    .price-old  { font-size:12px; color:var(--muted); text-decoration:line-through; }

    .prod-footer {
      padding:10px 14px; border-top:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .prod-footer-label { font-size:12px; color:var(--muted); }

    /* TOGGLE */
    .toggle { position:relative; width:40px; height:22px; cursor:pointer; display:block; flex-shrink:0; }
    .toggle input { opacity:0; width:0; height:0; position:absolute; }
    .t-track { position:absolute; inset:0; background:#ddd; border-radius:11px; transition:background .25s; }
    .toggle input:checked ~ .t-track { background:var(--accent); }
    .t-thumb { position:absolute; top:3px; left:3px; width:16px; height:16px; background:#fff; border-radius:50%; transition:transform .25s var(--ease); box-shadow:0 1px 3px rgba(0,0,0,.2); }
    .toggle input:checked ~ .t-thumb { transform:translateX(18px); }

    /* ADD CARD */
    .add-card {
      background:var(--surface); border-radius:var(--radius); border:2px dashed var(--border);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; aspect-ratio:3/4; cursor:pointer; color:var(--muted);
      transition:all .25s; min-height:240px;
    }
    .add-card:hover { border-color:var(--accent); color:var(--accent); background:rgba(201,169,110,.04); }
    .add-card i { font-size:28px; }
    .add-card span { font-size:13px; font-weight:500; }

    /* EMPTY */
    .empty { text-align:center; padding:80px 0; color:var(--muted); grid-column:1/-1; }
    .empty i { font-size:40px; opacity:.2; margin-bottom:14px; display:block; }

    /* MODAL */
    .backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:300;
      display:flex; align-items:center; justify-content:center; padding:20px;
      opacity:0; pointer-events:none; transition:opacity .3s;
    }
    .backdrop.open { opacity:1; pointer-events:all; }
    .modal {
      background:var(--surface); border-radius:12px; width:100%; max-width:520px;
      max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.2);
      transform:scale(.96) translateY(10px); transition:transform .3s var(--ease);
    }
    .backdrop.open .modal { transform:scale(1) translateY(0); }
    .modal-head {
      padding:24px 26px 0; display:flex; align-items:flex-start; justify-content:space-between;
    }
    .modal-title { font-family:var(--serif); font-size:24px; font-weight:500; }
    .modal-close {
      background:var(--bg); border:1px solid var(--border); color:var(--muted);
      width:32px; height:32px; border-radius:50%; cursor:pointer; display:grid;
      place-items:center; font-size:16px; transition:all .2s; flex-shrink:0;
    }
    .modal-close:hover { border-color:var(--red); color:var(--red); }
    .modal-body { padding:20px 26px; }
    .modal-foot { padding:16px 26px 24px; display:flex; justify-content:flex-end; gap:10px; }

    .form-row { margin-bottom:16px; }
    .form-label { display:block; font-size:12px; font-weight:500; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.08em; }
    .form-input, .form-select {
      width:100%; background:var(--bg); border:1.5px solid var(--border); border-radius:var(--radius);
      color:var(--text); font-family:var(--sans); font-size:14px; padding:11px 14px; outline:none; transition:border-color .2s;
    }
    .form-input:focus, .form-select:focus { border-color:var(--accent); background:var(--surface); }
    .form-input::placeholder { color:var(--muted); }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form-hint { font-size:11px; color:var(--muted); margin-top:5px; }

    .img-prev-wrap {
      border-radius:var(--radius); overflow:hidden; aspect-ratio:3/4; max-height:220px;
      background:#f0ede8; border:1.5px solid var(--border); margin-top:8px; display:none;
    }
    .img-prev-wrap.on { display:block; }
    .img-prev-wrap img { width:100%; height:100%; object-fit:cover; }

    /* CONFIG MODAL */
    .cfg-ok  { background:rgba(45,138,94,.1); color:var(--green); border:1px solid rgba(45,138,94,.2); border-radius:var(--radius); padding:10px 14px; font-size:13px; display:none; margin-top:10px; gap:8px; }
    .cfg-ok.on { display:flex; align-items:center; }
    .cfg-err { background:rgba(192,57,43,.08); color:var(--red); border:1px solid rgba(192,57,43,.2); border-radius:var(--radius); padding:10px 14px; font-size:13px; display:none; margin-top:10px; }
    .cfg-err.on { display:block; }
    .steps { background:var(--bg); border-radius:var(--radius); padding:16px; border:1px solid var(--border); margin-top:10px; }
    .steps ol { padding-left:18px; display:flex; flex-direction:column; gap:6px; }
    .steps li { font-size:13px; color:var(--muted); line-height:1.6; }
    .steps strong { color:var(--text); }
    .steps code { background:var(--surface); padding:1px 6px; border-radius:4px; border:1px solid var(--border); font-size:11px; }

    /* TOAST */
    .toast {
      position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(70px);
      z-index:999; padding:13px 22px; border-radius:var(--radius);
      font-size:14px; font-weight:500; display:flex; align-items:center; gap:10px;
      opacity:0; pointer-events:none; transition:all .4s var(--ease);
      box-shadow:0 4px 20px rgba(0,0,0,.15); white-space:nowrap;
    }
    .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
    .toast.ok   { background:#1a3325; color:#5dba8e; border:1px solid rgba(93,186,142,.2); }
    .toast.err  { background:#3a1515; color:#e06060; border:1px solid rgba(224,96,96,.2); }
    .toast.info { background:#1a1a17; color:var(--accent); border:1px solid rgba(201,169,110,.2); }

    /* SPINNER */
    .spinner { width:15px; height:15px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; display:inline-block; }
    @keyframes spin { to { transform:rotate(360deg); } }

    @media(max-width:640px){
      .topbar { padding:0 16px; }
      .page { padding:20px 14px; }
      .prod-grid { grid-template-columns:repeat(2,1fr); gap:10px; }
      .form-grid { grid-template-columns:1fr; }
      .cat-tabs { display:none; }
    }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">Bara &amp; Co</div>
    <div class="topbar-tag">Mis productos</div>
  </div>
  <div class="topbar-right">
    <a href="https://bara-and-co.github.io/Bara-Co/tienda.html" target="_blank" class="btn btn-ghost btn-sm">
      <i class="fas fa-store"></i> Ver tienda
    </a>
    <button class="btn btn-ghost btn-sm" onclick="openConfig()">
      <i class="fas fa-cog"></i> Configurar
    </button>
  </div>
</div>

<!-- PAGE -->
<div class="page">

  <!-- Banner cambios sin publicar -->
  <div class="save-banner" id="saveBanner">
    <div class="save-banner-txt">
      <strong id="bannerCount">1 cambio</strong> sin publicar en la tienda
      <small>Los cambios se guardan cuando presionÃ¡s "Publicar"</small>
    </div>
    <button class="btn btn-primary" onclick="publish()" id="publishBtn">
      <i class="fas fa-cloud-upload-alt"></i> Publicar ahora
    </button>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Buscar producto..." id="searchInput" oninput="renderGrid()"/>
    </div>
    <div class="cat-tabs">
      <div class="cat-tab active" onclick="setFilter(this,'')">Todos</div>
      <div class="cat-tab" onclick="setFilter(this,'new')">âœ¨ New</div>
      <div class="cat-tab" onclick="setFilter(this,'hombre')">Hombre</div>
      <div class="cat-tab" onclick="setFilter(this,'mujer')">Mujer</div>
      <div class="cat-tab" onclick="setFilter(this,'accesorios')">Accesorios</div>
    </div>
  </div>

  <!-- Grid -->
  <div class="prod-grid" id="prodGrid"></div>

</div>

<!-- MODAL PRODUCTO -->
<div class="backdrop" id="mProd" onclick="onBd(event,'mProd',closeModal)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2 class="modal-title" id="modalTitle">Nuevo producto</h2>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editId"/>

      <div class="form-row">
        <label class="form-label">Nombre del producto *</label>
        <input type="text" class="form-input" id="fNombre" placeholder="ej: Campera LAMPARD"/>
      </div>

      <div class="form-grid">
        <div class="form-row">
          <label class="form-label">Precio ($) *</label>
          <input type="number" class="form-input" id="fPrecio" placeholder="75000"/>
        </div>
        <div class="form-row">
          <label class="form-label">Precio anterior (para mostrar descuento)</label>
          <input type="number" class="form-input" id="fPrecioAnt" placeholder="Dejar vacÃ­o si no hay"/>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-row">
          <label class="form-label">CategorÃ­a *</label>
          <select class="form-select" id="fCat">
            <option value="new">âœ¨ New Collection</option>
            <option value="hombre">ðŸ‘” Hombre</option>
            <option value="mujer">ðŸ‘— Mujer</option>
            <option value="accesorios">ðŸ‘œ Accesorios</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Tipo (opcional)</label>
          <input type="text" class="form-input" id="fSub" placeholder="Camperas, Remeras..."/>
        </div>
      </div>

      <div class="form-row">
        <label class="form-label">URL de la foto del producto *</label>
        <input type="url" class="form-input" id="fImg" placeholder="https://..." oninput="previewImg()"/>
        <div class="form-hint">PegÃ¡ el link directo de la foto</div>
        <div class="img-prev-wrap" id="imgWrap">
          <img id="imgPrev" src="" alt="" onerror="document.getElementById('imgWrap').classList.remove('on')"/>
        </div>
      </div>

      <div class="form-row">
        <label class="form-label">Visible en la tienda</label>
        <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
          <label class="toggle">
            <input type="checkbox" id="fActivo" checked onchange="updActivoLabel()"/>
            <div class="t-track"></div><div class="t-thumb"></div>
          </label>
          <span id="activoLbl" style="font-size:13px;color:var(--green)">SÃ­, se muestra en la tienda</span>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveProduct()"><i class="fas fa-check"></i> Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIGURACIÃ“N -->
<div class="backdrop" id="mCfg" onclick="onBd(event,'mCfg',closeConfig)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2 class="modal-title">ConfiguraciÃ³n</h2>
      <button class="modal-close" onclick="closeConfig()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">ðŸ”‘ Token de GitHub (una sola vez)</label>
        <input type="password" class="form-input" id="cfgToken" placeholder="ghp_xxxxxxxxxxxxxxxx"/>
      </div>
      <div class="form-row">
        <label class="form-label">Repositorio</label>
        <input type="text" class="form-input" id="cfgRepo" value="bara-and-co/Bara-Co"/>
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="saveConfig()">
        <i class="fas fa-save"></i> Guardar configuraciÃ³n
      </button>
      <div class="cfg-ok" id="cfgOk"><i class="fas fa-check-circle"></i> Â¡Listo! Ya podÃ©s publicar cambios.</div>
      <div class="cfg-err" id="cfgErr"></div>

      <details style="margin-top:20px">
        <summary style="cursor:pointer;font-size:13px;color:var(--muted)">Â¿CÃ³mo obtengo el token? (clic para ver)</summary>
        <div class="steps">
          <ol>
            <li>EntrÃ¡ a <strong>github.com</strong> â†’ clic en tu foto â†’ <strong>Settings</strong></li>
            <li>BajÃ¡ hasta <strong>Developer settings</strong> â†’ <strong>Personal access tokens â†’ Tokens (classic)</strong></li>
            <li>Clic en <strong>Generate new token (classic)</strong></li>
            <li>Nombre: <code>bara-admin</code> Â· TildÃ¡: <strong>repo</strong> âœ“</li>
            <li>Clic en <strong>Generate token</strong> Â· CopiÃ¡ el token y pegalo arriba</li>
          </ol>
        </div>
      </details>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeConfig()">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* â”€â”€â”€ ESTADO â”€â”€â”€ */
let products = [];
let filterCat = '';
let pending = 0;

/* â”€â”€â”€ INIT â”€â”€â”€ */
async function init() {
  const t = localStorage.getItem('bc_gh_token') || '';
  const r = localStorage.getItem('bc_gh_repo')  || 'bara-and-co/Bara-Co';
  if (t) document.getElementById('cfgToken').value = t;
  document.getElementById('cfgRepo').value = r;

  // Cargar borrador local primero
  const draft = localStorage.getItem('bc_draft');
  if (draft) { try { products = JSON.parse(draft); } catch(e){} }

  // Si no hay borrador, cargar del repo
  if (!products.length) {
    for (const url of ['productos.json', 'https://bara-and-co.github.io/Bara-Co/productos.json']) {
      try { const res = await fetch(url+'?t='+Date.now()); if(res.ok){ products = await res.json(); break; } } catch(e){}
    }
  }
  renderGrid();
}

/* â”€â”€â”€ RENDER â”€â”€â”€ */
function renderGrid() {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const grid = document.getElementById('prodGrid');
  grid.innerHTML = '';

  const catMap = { new:'badge-new', hombre:'badge-hom', mujer:'badge-muj', accesorios:'badge-acc' };
  const catLbl = { new:'New', hombre:'Hombre', mujer:'Mujer', accesorios:'Acces.' };

  const list = products.filter(p =>
    (!q || p.nombre.toLowerCase().includes(q)) &&
    (!filterCat || p.categoria === filterCat)
  );

  if (!list.length) {
    grid.innerHTML = '<div class="empty"><i class="fas fa-box-open"></i><p>No hay productos aquÃ­ todavÃ­a</p></div>';
  } else {
    list.forEach(p => {
      const disc = p.precioAnterior ? Math.round((1-p.precio/p.precioAnterior)*100)+'%' : null;
      const el = document.createElement('div');
      el.className = 'prod-card' + (p.activo?'':' inactive');
      el.dataset.id = p.id;
      el.innerHTML = `
        <div class="prod-img">
          <span class="cat-badge ${catMap[p.categoria]||'badge-acc'}">${catLbl[p.categoria]||p.categoria}</span>
          ${disc?`<span class="disc-badge">-${disc}</span>`:''}
          <img src="${p.imagen}" alt="${p.nombre}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22400%22%3E%3Crect fill=%22%23f0ede8%22 width=%22300%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23c9a96e%22 font-size=%2214%22%3ESin imagen%3C/text%3E%3C/svg%3E'"/>
          <div class="prod-overlay">
            <button class="ov-btn" title="Editar" onclick="event.stopPropagation();openModal('${p.id}')"><i class="fas fa-pen"></i></button>
            <button class="ov-btn del" title="Eliminar" onclick="event.stopPropagation();deleteP('${p.id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="prod-info">
          <div class="prod-name">${p.nombre}</div>
          <div class="prod-price">
            <span class="price-main">$${p.precio.toLocaleString('es-AR')}</span>
            ${p.precioAnterior?`<span class="price-old">$${p.precioAnterior.toLocaleString('es-AR')}</span>`:''}
          </div>
        </div>
        <div class="prod-footer">
          <span class="prod-footer-label">${p.activo?'âœ“ Visible':'Oculto'}</span>
          <label class="toggle">
            <input type="checkbox" ${p.activo?'checked':''} onchange="toggleA('${p.id}',this.checked)"/>
            <div class="t-track"></div><div class="t-thumb"></div>
          </label>
        </div>`;
      grid.appendChild(el);
    });
  }

  // Tarjeta agregar
  if (!q) {
    const add = document.createElement('div');
    add.className = 'add-card';
    add.onclick = () => openModal();
    add.innerHTML = '<i class="fas fa-plus"></i><span>Agregar producto</span>';
    grid.appendChild(add);
  }
}

/* â”€â”€â”€ FILTROS â”€â”€â”€ */
function setFilter(el, cat) {
  filterCat = cat;
  document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderGrid();
}

/* â”€â”€â”€ TOGGLE ACTIVO â”€â”€â”€ */
function toggleA(id, val) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  p.activo = val;
  const card = document.querySelector(`.prod-card[data-id="${id}"]`);
  if (card) {
    card.classList.toggle('inactive', !val);
    const lbl = card.querySelector('.prod-footer-label');
    if (lbl) lbl.textContent = val ? 'âœ“ Visible' : 'Oculto';
  }
  dirty();
}

/* â”€â”€â”€ MODAL PRODUCTO â”€â”€â”€ */
let editId = null;

function openModal(id = null) {
  editId = id;
  document.getElementById('modalTitle').textContent = id ? 'Editar producto' : 'Nuevo producto';
  document.getElementById('imgWrap').classList.remove('on');

  if (id) {
    const p = products.find(x => x.id === id);
    if (!p) return;
    document.getElementById('fNombre').value   = p.nombre;
    document.getElementById('fPrecio').value   = p.precio;
    document.getElementById('fPrecioAnt').value= p.precioAnterior || '';
    document.getElementById('fCat').value      = p.categoria;
    document.getElementById('fSub').value      = p.subcategoria || '';
    document.getElementById('fImg').value      = p.imagen;
    document.getElementById('fActivo').checked = p.activo;
    if (p.imagen) { document.getElementById('imgPrev').src = p.imagen; document.getElementById('imgWrap').classList.add('on'); }
  } else {
    ['fNombre','fPrecio','fPrecioAnt','fSub','fImg'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('fCat').value = 'hombre';
    document.getElementById('fActivo').checked = true;
  }
  updActivoLabel();
  document.getElementById('mProd').classList.add('open');
  setTimeout(() => document.getElementById('fNombre').focus(), 100);
}

function closeModal() { document.getElementById('mProd').classList.remove('open'); editId = null; }

function updActivoLabel() {
  const on = document.getElementById('fActivo').checked;
  const lbl = document.getElementById('activoLbl');
  lbl.textContent = on ? 'SÃ­, se muestra en la tienda' : 'No, estÃ¡ oculto';
  lbl.style.color = on ? 'var(--green)' : 'var(--muted)';
}

function previewImg() {
  const url = document.getElementById('fImg').value.trim();
  if (url) { document.getElementById('imgPrev').src = url; document.getElementById('imgWrap').classList.add('on'); }
  else { document.getElementById('imgWrap').classList.remove('on'); }
}

function saveProduct() {
  const nombre = document.getElementById('fNombre').value.trim();
  const precio = parseInt(document.getElementById('fPrecio').value);
  const imagen = document.getElementById('fImg').value.trim();
  if (!nombre) { toast('IngresÃ¡ el nombre del producto','err'); return; }
  if (!precio||precio<1) { toast('IngresÃ¡ un precio vÃ¡lido','err'); return; }
  if (!imagen) { toast('IngresÃ¡ la URL de la imagen','err'); return; }

  const ant = parseInt(document.getElementById('fPrecioAnt').value);
  const prod = {
    id: editId || nombre.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') + '-' + Date.now(),
    nombre, precio,
    precioAnterior: (ant && ant > precio) ? ant : null,
    categoria: document.getElementById('fCat').value,
    subcategoria: document.getElementById('fSub').value.trim(),
    genero: 'unisex', imagen,
    activo: document.getElementById('fActivo').checked
  };

  if (editId) {
    const idx = products.findIndex(x => x.id === editId);
    if (idx !== -1) products[idx] = prod;
    toast('Producto actualizado âœ“');
  } else {
    products.unshift(prod);
    toast('Producto agregado âœ“');
  }
  closeModal(); dirty(); renderGrid();
}

/* â”€â”€â”€ DELETE â”€â”€â”€ */
function deleteP(id) {
  const p = products.find(x => x.id === id);
  if (!p || !confirm(`Â¿Eliminar "${p.nombre}"?`)) return;
  products = products.filter(x => x.id !== id);
  dirty(); renderGrid(); toast('Producto eliminado');
}

/* â”€â”€â”€ DIRTY / BANNER â”€â”€â”€ */
function dirty() {
  pending++;
  const b = document.getElementById('saveBanner');
  b.classList.add('show');
  document.getElementById('bannerCount').textContent = pending === 1 ? '1 cambio' : `${pending} cambios`;
  localStorage.setItem('bc_draft', JSON.stringify(products));
}

/* â”€â”€â”€ PUBLICAR EN GITHUB â”€â”€â”€ */
async function publish() {
  const token = localStorage.getItem('bc_gh_token');
  const repo  = localStorage.getItem('bc_gh_repo') || 'bara-and-co/Bara-Co';
  if (!token) { openConfig(); toast('Primero configurÃ¡ tu token de GitHub','err'); return; }

  const btn = document.getElementById('publishBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Publicando...';

  try {
    const getR = await fetch(`https://api.github.com/repos/${repo}/contents/productos.json`, {
      headers:{ Authorization:`token ${token}`, Accept:'application/vnd.github.v3+json' }
    });
    const sha = getR.ok ? (await getR.json()).sha : null;

    const json = JSON.stringify(products, null, 2);
    const b64  = btoa(unescape(encodeURIComponent(json)));
    const now  = new Date().toLocaleString('es-AR');

    const putR = await fetch(`https://api.github.com/repos/${repo}/contents/productos.json`, {
      method:'PUT',
      headers:{ Authorization:`token ${token}`, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
      body: JSON.stringify({ message:`Admin: actualizar productos â€” ${now}`, content:b64, ...(sha?{sha}:{}) })
    });

    if (!putR.ok) { const e = await putR.json(); throw new Error(e.message || 'Error al publicar'); }

    pending = 0;
    document.getElementById('saveBanner').classList.remove('show');
    localStorage.removeItem('bc_draft');
    toast('Â¡Publicado! La tienda se actualiza en 1-2 minutos ðŸŽ‰','ok');

  } catch(e) {
    toast('Error: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publicar ahora';
  }
}

/* â”€â”€â”€ CONFIGURACIÃ“N â”€â”€â”€ */
function openConfig() { document.getElementById('cfgOk').classList.remove('on'); document.getElementById('cfgErr').classList.remove('on'); document.getElementById('mCfg').classList.add('open'); }
function closeConfig(e) { if(e&&e.target!==document.getElementById('mCfg')) return; document.getElementById('mCfg').classList.remove('open'); }

function saveConfig() {
  const t = document.getElementById('cfgToken').value.trim();
  const r = document.getElementById('cfgRepo').value.trim();
  if (!t||!r) { document.getElementById('cfgErr').textContent='CompletÃ¡ el token y el repositorio'; document.getElementById('cfgErr').classList.add('on'); return; }
  localStorage.setItem('bc_gh_token', t);
  localStorage.setItem('bc_gh_repo', r);
  document.getElementById('cfgOk').classList.add('on');
  document.getElementById('cfgErr').classList.remove('on');
}

/* â”€â”€â”€ UTILS â”€â”€â”€ */
function onBd(e, id, fn) { if(e.target===document.getElementById(id)) fn(); }

let toastTmr;
function toast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = `toast show ${type}`;
  clearTimeout(toastTmr); toastTmr = setTimeout(() => el.classList.remove('show'), 3500);
}
document.addEventListener('keydown', e => { if(e.key==='Escape'){ closeModal(); document.getElementById('mCfg').classList.remove('open'); } });

init();
</script>
</body>
</html>
