<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Admin ¬∑ Bara & Co</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --bg:      #f7f6f3;
      --surface: #ffffff;
      --border:  #e8e4dd;
      --text:    #1a1a17;
      --muted:   #8a8680;
      --accent:  #c9a96e;
      --adk:     #a07e48;
      --green:   #2d8a5e;
      --red:     #c0392b;
      --blue:    #3d6bce;
      --purple:  #8e44ad;
      --serif:   'Cormorant Garamond', serif;
      --sans:    'DM Sans', sans-serif;
      --ease:    cubic-bezier(.16,1,.3,1);
      --shadow:  0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
      --radius:  8px;
    }
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body { background:var(--bg); color:var(--text); font-family:var(--sans); font-size:15px; line-height:1.6; -webkit-font-smoothing:antialiased; }
    img { display:block; }

    /* TOPBAR */
    .topbar {
      background:var(--surface); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:100;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 32px; height:68px;
    }
    .topbar-left { display:flex; align-items:center; gap:14px; }
    .topbar-logo { font-family:var(--serif); font-size:22px; font-weight:500; }
    .topbar-tag  { font-size:10px; letter-spacing:.15em; text-transform:uppercase; color:var(--accent); background:rgba(201,169,110,.1); padding:3px 9px; border-radius:20px; }
    .topbar-right { display:flex; align-items:center; gap:10px; }
    .topbar-stats {
      display:flex; gap:16px; margin-right:16px; font-size:12px;
    }
    .stat-item { display:flex; align-items:center; gap:4px; color:var(--muted); }
    .stat-item i { color:var(--accent); }

    /* BOTONES */
    .btn {
      display:inline-flex; align-items:center; gap:7px;
      padding:10px 20px; border:none; cursor:pointer;
      font-family:var(--sans); font-size:13px; font-weight:500;
      border-radius:var(--radius); transition:all .2s; white-space:nowrap;
    }
    .btn-primary { background:var(--accent); color:#fff; }
    .btn-primary:hover { background:var(--adk); transform:translateY(-1px); box-shadow:0 4px 12px rgba(201,169,110,.35); }
    .btn-ghost { background:var(--surface); color:var(--text); border:1px solid var(--border); }
    .btn-ghost:hover { background:var(--bg); }
    .btn-danger { background:rgba(192,57,43,.08); color:var(--red); border:1px solid rgba(192,57,43,.2); }
    .btn-danger:hover { background:rgba(192,57,43,.15); }
    .btn-sm { padding:7px 14px; font-size:12px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; transform:none !important; }

    /* PAGE */
    .page { max-width:1200px; margin:0 auto; padding:32px 24px; }

    /* SAVE BANNER */
    .save-banner {
      background:linear-gradient(135deg,#1a1a17,#2d2d28);
      color:#fff; border-radius:var(--radius); padding:18px 24px;
      margin-bottom:28px; display:none;
      align-items:center; justify-content:space-between; gap:16px;
      box-shadow:var(--shadow);
    }
    .save-banner.show { display:flex; }
    .save-banner-txt strong { color:var(--accent); }
    .save-banner-txt small { color:rgba(255,255,255,.5); font-size:12px; display:block; margin-top:2px; }

    /* TOOLBAR */
    .toolbar { display:flex; align-items:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .search-box {
      display:flex; align-items:center; gap:8px;
      background:var(--surface); border:1.5px solid var(--border); border-radius:var(--radius);
      padding:9px 14px; flex:1; min-width:180px; max-width:280px; transition:border-color .2s;
    }
    .search-box:focus-within { border-color:var(--accent); }
    .search-box i { color:var(--muted); font-size:13px; }
    .search-box input { background:none; border:none; outline:none; color:var(--text); font-family:var(--sans); font-size:14px; width:100%; }
    .search-box input::placeholder { color:var(--muted); }
    .cat-tabs { display:flex; gap:6px; flex-wrap:wrap; }
    .cat-tab {
      padding:7px 14px; border-radius:20px; font-size:12px; font-weight:500;
      border:1px solid var(--border); background:var(--surface); color:var(--muted);
      cursor:pointer; transition:all .2s;
    }
    .cat-tab:hover { border-color:var(--accent); color:var(--accent); }
    .cat-tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }

    /* GRID */
    .prod-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:16px; }

    /* CARD */
    .prod-card {
      background:var(--surface); border-radius:var(--radius); border:1px solid var(--border);
      overflow:hidden; transition:all .25s var(--ease); position:relative;
    }
    .prod-card:hover { box-shadow:var(--shadow); transform:translateY(-2px); }
    .prod-card.inactive { opacity:.55; }
    .prod-card.inactive .prod-img { filter:grayscale(.7); }

    .prod-img { aspect-ratio:3/4; overflow:hidden; background:#f0ede8; position:relative; }
    .prod-img img { width:100%; height:100%; object-fit:cover; transition:transform .5s var(--ease); }
    .prod-card:hover .prod-img img { transform:scale(1.04); }

    .cat-badge {
      position:absolute; top:10px; left:10px; z-index:2;
      font-size:8px; font-weight:600; letter-spacing:.1em; text-transform:uppercase;
      padding:3px 8px; border-radius:20px;
    }
    .badge-new { background:var(--accent); color:#fff; }
    .badge-hom { background:var(--blue); color:#fff; }
    .badge-muj { background:var(--purple); color:#fff; }
    .badge-acc { background:var(--green); color:#fff; }
    .badge-lentes { background:#4a6fa5; color:#fff; }      /* Nuevo */
    .badge-bijou { background:#d4af37; color:#fff; }      /* Nuevo */
    .badge-billeteras { background:#8b5a2b; color:#fff; } /* Nuevo */
    .badge-medias { background:#cd5c5c; color:#fff; }     /* Nuevo */
    .badge-boxers { background:#2e8b57; color:#fff; }     /* Nuevo */
    .badge-zapatillas { background:#4682b4; color:#fff; } /* Nuevo */
    
    .disc-badge {
      position:absolute; top:10px; right:10px; z-index:2;
      background:var(--red); color:#fff; font-size:9px; font-weight:700; padding:3px 7px; border-radius:4px;
    }

    .prod-badges {
      position:absolute; bottom:10px; left:10px; right:10px; z-index:2;
      display:flex; gap:4px; flex-wrap:wrap;
    }
    .mini-badge {
      background:rgba(0,0,0,.7); color:#fff; font-size:8px; padding:2px 6px;
      border-radius:12px; display:flex; align-items:center; gap:3px;
    }

    .prod-overlay {
      position:absolute; inset:0; background:rgba(0,0,0,.42);
      display:flex; align-items:center; justify-content:center; gap:10px;
      opacity:0; transition:opacity .25s;
    }
    .prod-card:hover .prod-overlay { opacity:1; }
    .ov-btn {
      background:#fff; color:var(--text); border:none; cursor:pointer;
      width:40px; height:40px; border-radius:50%; display:grid; place-items:center;
      font-size:14px; transition:all .2s;
    }
    .ov-btn:hover { background:var(--accent); color:#fff; transform:scale(1.1); }
    .ov-btn.del:hover { background:var(--red); }
    .ov-btn.dup:hover { background:var(--blue); }

    .prod-info { padding:14px; }
    .prod-name { font-weight:500; font-size:14px; line-height:1.3; margin-bottom:6px; }
    .prod-price { display:flex; align-items:baseline; gap:6px; }
    .price-main { font-family:var(--serif); font-size:18px; color:var(--accent); }
    .price-old  { font-size:12px; color:var(--muted); text-decoration:line-through; }

    .prod-footer {
      padding:10px 14px; border-top:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .prod-footer-label { font-size:12px; color:var(--muted); }

    /* TOGGLE */
    .toggle { position:relative; width:40px; height:22px; cursor:pointer; display:block; flex-shrink:0; }
    .toggle input { opacity:0; width:0; height:0; position:absolute; }
    .t-track { position:absolute; inset:0; background:#ddd; border-radius:11px; transition:background .25s; }
    .toggle input:checked ~ .t-track { background:var(--accent); }
    .toggle-outlet input:checked ~ .t-track { background:#e07b39; }
    .t-thumb { position:absolute; top:3px; left:3px; width:16px; height:16px; background:#fff; border-radius:50%; transition:transform .25s var(--ease); box-shadow:0 1px 3px rgba(0,0,0,.2); }
    .toggle input:checked ~ .t-thumb { transform:translateX(18px); }

    /* ADD CARD */
    .add-card {
      background:var(--surface); border-radius:var(--radius); border:2px dashed var(--border);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; aspect-ratio:3/4; cursor:pointer; color:var(--muted);
      transition:all .25s; min-height:240px;
    }
    .add-card:hover { border-color:var(--accent); color:var(--accent); background:rgba(201,169,110,.04); }
    .add-card i { font-size:28px; }
    .add-card span { font-size:13px; font-weight:500; }

    /* EMPTY */
    .empty { text-align:center; padding:80px 0; color:var(--muted); grid-column:1/-1; }
    .empty i { font-size:40px; opacity:.2; margin-bottom:14px; display:block; }

    /* MODAL */
    .backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:300;
      display:flex; align-items:center; justify-content:center; padding:20px;
      opacity:0; pointer-events:none; transition:opacity .3s;
    }
    .backdrop.open { opacity:1; pointer-events:all; }
    .modal {
      background:var(--surface); border-radius:12px; width:100%; max-width:720px;
      max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.2);
      transform:scale(.96) translateY(10px); transition:transform .3s var(--ease);
    }
    .backdrop.open .modal { transform:scale(1) translateY(0); }
    .modal-head {
      padding:24px 26px 0; display:flex; align-items:flex-start; justify-content:space-between;
      position:sticky; top:0; background:var(--surface); z-index:10;
      border-bottom:1px solid var(--border); padding-bottom:16px;
    }
    .modal-title { font-family:var(--serif); font-size:24px; font-weight:500; }
    .modal-close {
      background:var(--bg); border:1px solid var(--border); color:var(--muted);
      width:32px; height:32px; border-radius:50%; cursor:pointer; display:grid;
      place-items:center; font-size:16px; transition:all .2s; flex-shrink:0;
    }
    .modal-close:hover { border-color:var(--red); color:var(--red); }
    .modal-body { padding:20px 26px; }
    .modal-foot { padding:16px 26px 24px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid var(--border); }

    /* FORM */
    .form-row { margin-bottom:20px; }
    .form-label { display:block; font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.08em; }
    .form-input, .form-select, .form-textarea {
      width:100%; background:var(--bg); border:1.5px solid var(--border); border-radius:var(--radius);
      color:var(--text); font-family:var(--sans); font-size:14px; padding:11px 14px; outline:none; transition:border-color .2s;
    }
    .form-textarea { min-height:100px; resize:vertical; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color:var(--accent); background:var(--surface); }
    .form-input::placeholder { color:var(--muted); }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-hint { font-size:11px; color:var(--muted); margin-top:5px; display:flex; align-items:center; gap:5px; }

    /* IMAGEN PREVIEW (legacy, keep for compat) */
    .img-prev-wrap {
      border-radius:var(--radius); overflow:hidden; aspect-ratio:3/4; max-height:220px;
      background:#f0ede8; border:1.5px solid var(--border); margin-top:8px; display:none;
    }
    .img-prev-wrap.on { display:block; }
    .img-prev-wrap img { width:100%; height:100%; object-fit:cover; }

    /* ‚îÄ‚îÄ‚îÄ UPLOADER ‚îÄ‚îÄ‚îÄ */
    .img-upload-zone {
      display: block;
      position: relative;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: border-color .2s, background .2s;
      overflow: hidden;
      min-height: 160px;
      background: var(--bg);
      text-align: center;
    }    .img-upload-zone:hover,
    .img-upload-zone.drag-over {
      border-color: var(--accent);
      background: rgba(201,169,110,.05);
    }
    .img-upload-zone.drag-over { border-style: solid; }
    .img-upload-zone.has-image { border-style: solid; border-color: var(--accent); }

    .upload-idle {
      padding: 36px 20px;
      text-align: center;
      pointer-events: none;
    }
    .upload-icon {
      font-size: 36px;
      color: var(--accent);
      opacity: .6;
      margin-bottom: 12px;
    }
    .upload-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--text);
      margin-bottom: 4px;
    }
    .upload-sub {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .upload-formats {
      font-size: 11px;
      color: var(--muted);
      background: var(--border);
      padding: 3px 10px;
      border-radius: 20px;
      display: inline-block;
    }

    .upload-preview {
      width: 100%;
      position: relative;
    }
    .upload-preview img {
      width: 100%;
      max-height: 280px;
      object-fit: contain;
      display: block;
      background: #f0ede8;
    }
    .upload-clear {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(0,0,0,.55);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: grid;
      place-items: center;
      transition: background .2s;
      z-index: 5;
    }
    .upload-clear:hover { background: var(--red); }
    .upload-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: var(--green);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .url-fallback {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .url-fallback summary {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 0;
      user-select: none;
      list-style: none;
    }
    .url-fallback summary::-webkit-details-marker { display: none; }
    .url-fallback summary:hover { color: var(--accent); }

    /* Extra images grid */
    .extra-imgs-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .extra-img-item {
      position: relative;
      width: 72px;
      height: 72px;
      border-radius: 6px;
      overflow: hidden;
      border: 1.5px solid var(--border);
      flex-shrink: 0;
    }
    .extra-img-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .extra-img-remove {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,0,0,.6);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 10px;
      display: grid;
      place-items: center;
    }
    .extra-add-btn {
      width: 72px;
      height: 72px;
      border-radius: 6px;
      border: 2px dashed var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      color: var(--muted);
      font-size: 11px;
      transition: all .2s;
      flex-shrink: 0;
    }
    .extra-add-btn:hover { border-color: var(--accent); color: var(--accent); }
    .extra-add-btn i { font-size: 18px; }

    /* Upload progress */
    .upload-progress {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      z-index: 10;
      display: none;
    }
    .upload-progress.show { display: flex; }
    .progress-bar-wrap {
      width: 120px;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      width: 0%;
      transition: width .3s;
    }
    .progress-label { font-size: 12px; color: var(--muted); }

    /* GESTI√ìN DE TALLES */
    .sizes-section {
      border:1px solid var(--border); border-radius:var(--radius); padding:16px;
      background:var(--bg); margin-bottom:20px;
    }
    .section-title {
      font-weight:600; font-size:14px; margin-bottom:12px; display:flex; align-items:center; gap:8px;
    }
    .size-options {
      display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;
    }
    .size-chip {
      background:var(--surface); border:1px solid var(--border); border-radius:20px;
      padding:6px 12px; font-size:13px; display:flex; align-items:center; gap:6px;
    }
    .size-chip.selected {
      background:var(--accent); color:#fff; border-color:var(--accent);
    }
    .size-chip input[type="checkbox"] {
      width:16px; height:16px; accent-color:var(--accent);
    }
    .size-chip.disabled { opacity:.4; background:#eee; }
    
    .size-row {
      display:flex; align-items:center; gap:10px; margin-bottom:8px;
      padding:8px; background:var(--surface); border-radius:var(--radius);
    }
    .size-label { width:50px; font-weight:600; }
    .size-stock { width:80px; }

    /* GESTI√ìN DE COLORES */
    /* Stock grid */
    .stock-table { border-collapse:collapse; min-width:100%; font-size:12px; }
    .stock-table th {
      background: var(--bg2);
      padding: 7px 10px;
      text-align: center;
      font-weight: 600;
      font-family: var(--sans);
      color: var(--muted);
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    .stock-table th.color-header {
      text-align: left;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 110px;
    }
    .stock-table td {
      border: 1px solid var(--border);
      padding: 5px 8px;
      text-align: center;
    }
    .stock-table td:first-child {
      text-align: left;
      font-weight: 500;
      background: var(--bg2);
      white-space: nowrap;
    }
    .stock-dot {
      width: 14px; height: 14px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
      border: 1px solid rgba(0,0,0,.15);
    }
    .stock-input {
      width: 52px;
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--fg);
      font-size: 12px;
      font-family: var(--sans);
      text-align: center;
    }
    .stock-input:focus { outline: none; border-color: var(--accent); }
    .stock-input.sin-stock { border-color: #e05555; color: #e05555; background: rgba(224,85,85,.07); }
    .stock-total-badge {
      display: inline-block;
      background: rgba(201,169,110,.15);
      color: var(--accent);
      border-radius: 20px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    /* Color Picker */
    .cpicker {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 10px;
    }
    .cp-gradient {
      width: 100%;
      height: 180px;
      border-radius: 6px;
      position: relative;
      cursor: crosshair;
      background: linear-gradient(to bottom, transparent, #000),
                  linear-gradient(to right, #fff, hsl(0,100%,50%));
      margin-bottom: 10px;
      user-select: none;
    }
    .cp-cursor {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,.4), 0 2px 4px rgba(0,0,0,.3);
      transform: translate(-50%, -50%);
      pointer-events: none;
      top: 20%;
      left: 80%;
    }
    .cp-sliders {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .cp-preview {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: #000;
      flex-shrink: 0;
    }
    .cp-eyedrop { flex-shrink: 0; }
    .cp-slider-col { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    .cp-hue {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 6px;
      background: linear-gradient(to right,
        hsl(0,100%,50%), hsl(30,100%,50%), hsl(60,100%,50%),
        hsl(90,100%,50%), hsl(120,100%,50%), hsl(150,100%,50%),
        hsl(180,100%,50%), hsl(210,100%,50%), hsl(240,100%,50%),
        hsl(270,100%,50%), hsl(300,100%,50%), hsl(330,100%,50%), hsl(360,100%,50%));
      cursor: pointer;
      outline: none;
      border: 1px solid var(--border);
    }
    .cp-hue::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid rgba(0,0,0,.3);
      box-shadow: 0 1px 3px rgba(0,0,0,.3);
      cursor: pointer;
    }
    .cp-bottom {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .cp-hex {
      width: 90px;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--fg);
      font-family: monospace;
      font-size: 13px;
      text-transform: uppercase;
    }
    .cp-name-input {
      flex: 1;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--fg);
      font-family: var(--sans);
      font-size: 13px;
    }
    .cp-add-btn {
      padding: 7px 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .cp-add-btn:hover { opacity: .85; }
    .color-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }
    .color-chip {
      position: relative;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,.12);
      cursor: pointer;
      transition: all .2s;
      flex-shrink: 0;
    }
    .color-chip:hover { transform: scale(1.15); }
    .color-chip.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent);
      transform: scale(1.15);
    }
    .color-chip.selected::after {
      content: '‚úì';
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 14px;
      font-weight: 700;
      color: rgba(255,255,255,.9);
      text-shadow: 0 1px 3px rgba(0,0,0,.5);
    }
    .color-chip-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .color-chip-label {
      font-size: 9px;
      font-family: var(--sans);
      color: var(--muted);
      text-align: center;
      line-height: 1;
      max-width: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .color-chip-wrap:hover .color-chip-label { color: var(--fg); }
    .color-chip-wrap.selected-wrap .color-chip-label { color: var(--accent); font-weight: 600; }
    .cp-chip-remove {
      display: none;
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--red);
      color: #fff;
      border: none;
      font-size: 10px;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      align-items: center;
      justify-content: center;
    }
    .color-chip-wrap { position: relative; }
    .color-chip-wrap:hover .cp-chip-remove { display: flex; }
    .color-stock-wrap {
      margin-top: 3px;
      display: flex;
      justify-content: center;
    }
    .color-stock-input {
      width: 42px;
      padding: 2px 4px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--fg);
      font-size: 11px;
      font-family: var(--sans);
      text-align: center;
      display: none;
    }
    .color-chip-wrap.selected-wrap .color-stock-input { display: block; }
    .color-stock-input:focus { outline: none; border-color: var(--accent); }
    /* Stock = 0 ‚Üí clase js-sin-stock */
    .color-stock-input.sin-stock { border-color: #e05555; color: #e05555; }

    /* M√öLTIPLES IM√ÅGENES */
    .images-grid {
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px;
    }
    .image-item {
      aspect-ratio:3/4; border-radius:var(--radius); overflow:hidden;
      border:2px solid transparent; position:relative;
    }
    .image-item.primary { border-color:var(--accent); }
    .image-item img { width:100%; height:100%; object-fit:cover; }
    .image-remove {
      position:absolute; top:4px; right:4px; width:24px; height:24px;
      background:rgba(0,0,0,.7); color:#fff; border:none; border-radius:50%;
      cursor:pointer; display:grid; place-items:center; font-size:12px;
    }
    .image-remove:hover { background:var(--red); }

    /* IMPORT/EXPORT */
    .import-export {
      display:flex; gap:10px; margin-left:auto;
    }

    /* PREVIEW CARD */
    .preview-card {
      position:fixed; bottom:100px; right:30px; width:200px;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
      opacity:0; transform:translateX(20px); transition:all .3s;
      pointer-events:none; z-index:50;
    }
    .preview-card.show { opacity:1; transform:translateX(0); }
    .preview-img { aspect-ratio:3/4; background:#f0ede8; }
    .preview-img img { width:100%; height:100%; object-fit:cover; }
    .preview-info { padding:10px; font-size:12px; }
    .preview-name { font-weight:600; margin-bottom:4px; }
    .preview-price { color:var(--accent); }

    /* ESTAD√çSTICAS */
    .stats-panel {
      display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:24px;
    }
    .stat-card {
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius); padding:16px; display:flex;
      align-items:center; gap:12px;
    }
    .stat-icon {
      width:40px; height:40px; border-radius:50%;
      background:rgba(201,169,110,.1); display:grid; place-items:center;
    }
    .stat-icon i { color:var(--accent); font-size:18px; }
    .stat-content h3 { font-size:24px; font-weight:600; line-height:1.2; }
    .stat-content p { font-size:12px; color:var(--muted); }

    /* CONFIG MODAL */
    .cfg-ok  { background:rgba(45,138,94,.1); color:var(--green); border:1px solid rgba(45,138,94,.2); border-radius:var(--radius); padding:10px 14px; font-size:13px; display:none; margin-top:10px; gap:8px; }
    .cfg-ok.on { display:flex; align-items:center; }
    .cfg-err { background:rgba(192,57,43,.08); color:var(--red); border:1px solid rgba(192,57,43,.2); border-radius:var(--radius); padding:10px 14px; font-size:13px; display:none; margin-top:10px; }
    .cfg-err.on { display:block; }
    .steps { background:var(--bg); border-radius:var(--radius); padding:16px; border:1px solid var(--border); margin-top:10px; }
    .steps ol { padding-left:18px; display:flex; flex-direction:column; gap:6px; }
    .steps li { font-size:13px; color:var(--muted); line-height:1.6; }
    .steps strong { color:var(--text); }
    .steps code { background:var(--surface); padding:1px 6px; border-radius:4px; border:1px solid var(--border); font-size:11px; }

    /* TOAST */
    .toast {
      position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(70px);
      z-index:999; padding:13px 22px; border-radius:var(--radius);
      font-size:14px; font-weight:500; display:flex; align-items:center; gap:10px;
      opacity:0; pointer-events:none; transition:all .4s var(--ease);
      box-shadow:0 4px 20px rgba(0,0,0,.15); white-space:nowrap;
    }
    .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
    .toast.ok   { background:#1a3325; color:#5dba8e; border:1px solid rgba(93,186,142,.2); }
    .toast.err  { background:#3a1515; color:#e06060; border:1px solid rgba(224,96,96,.2); }
    .toast.info { background:#1a1a17; color:var(--accent); border:1px solid rgba(201,169,110,.2); }

    /* LOGIN SCREEN */
    #loginScreen {
      position:fixed; inset:0; background:var(--bg);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; flex-direction:column; gap:0;
    }
    #loginScreen.hidden { display:none; }
    .login-box {
      background:var(--surface); border:1px solid var(--border);
      border-radius:12px; padding:44px 40px; width:min(380px,92vw);
      box-shadow:0 8px 40px rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:20px;
    }
    .login-logo { font-family:var(--serif); font-size:28px; font-weight:500; text-align:center; letter-spacing:.02em; }
    .login-sub { text-align:center; font-size:13px; color:var(--muted); margin-top:-12px; }
    .login-field { display:flex; flex-direction:column; gap:6px; }
    .login-field label { font-size:12px; font-weight:500; color:var(--muted); letter-spacing:.05em; text-transform:uppercase; }
    .login-field input {
      padding:12px 14px; border:1.5px solid var(--border); border-radius:var(--radius);
      font-family:var(--sans); font-size:15px; outline:none; transition:border-color .2s;
      background:var(--bg);
    }
    .login-field input:focus { border-color:var(--accent); }
    .login-err { color:var(--red); font-size:13px; text-align:center; min-height:18px; }
    .login-btn { background:var(--accent); color:#fff; border:none; border-radius:var(--radius); padding:13px; font-family:var(--sans); font-size:14px; font-weight:600; cursor:pointer; transition:background .2s; letter-spacing:.04em; }
    .login-btn:hover { background:var(--adk); }
    .login-hint { text-align:center; font-size:11px; color:var(--muted); }

    /* SPINNER */
    .spinner { width:15px; height:15px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; display:inline-block; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ‚îÄ‚îÄ‚îÄ MODAL TABS ‚îÄ‚îÄ‚îÄ */
    .modal-tabs {
      display: flex; gap: 4px; padding: 0 26px; margin-bottom: -1px;
      border-bottom: 1px solid var(--border); background: var(--surface);
      position: sticky; top: 69px; z-index: 9;
    }
    .modal-tab {
      padding: 10px 16px; font-size: 13px; font-weight: 500;
      border: none; background: none; cursor: pointer; color: var(--muted);
      border-bottom: 2px solid transparent; margin-bottom: -1px;
      font-family: var(--sans); transition: all .2s; display: flex; align-items: center; gap: 6px;
    }
    .modal-tab:hover { color: var(--text); }
    .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ‚îÄ‚îÄ‚îÄ FABRIC COMPOSITION ‚îÄ‚îÄ‚îÄ */
    .fabric-section {
      border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px; background: var(--bg); margin-bottom: 20px;
    }
    .fabric-title {
      font-weight: 600; font-size: 14px; margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px; color: var(--text);
    }
    .fabric-total-badge {
      margin-left: auto; font-size: 12px; font-weight: 600;
      padding: 3px 10px; border-radius: 20px; transition: all .3s;
    }
    .fabric-total-badge.ok { background: rgba(45,138,94,.12); color: var(--green); }
    .fabric-total-badge.warn { background: rgba(192,57,43,.1); color: var(--red); }
    .fabric-total-badge.partial { background: rgba(201,169,110,.12); color: var(--accent); }
    .fabric-row {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .fabric-label {
      width: 100px; font-size: 13px; font-weight: 500; flex-shrink: 0;
      display: flex; align-items: center; gap: 6px;
    }
    .fabric-slider-wrap { flex: 1; position: relative; }
    .fabric-slider {
      -webkit-appearance: none; width: 100%; height: 6px;
      border-radius: 3px; outline: none; cursor: pointer;
      background: var(--border); transition: background .2s;
    }
    .fabric-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px;
      border-radius: 50%; background: var(--accent); cursor: pointer;
      border: 2px solid #fff; box-shadow: 0 1px 4px rgba(0,0,0,.2);
    }
    .fabric-pct {
      width: 52px; text-align: center; font-size: 13px; font-weight: 600;
      color: var(--accent); background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 6px; font-family: var(--sans);
      flex-shrink: 0;
    }
    .fabric-bar-visual {
      height: 8px; border-radius: 4px; margin-top: 4px; overflow: hidden;
      background: var(--border); display: flex;
    }
    .fabric-bar-segment {
      height: 100%; transition: width .3s var(--ease);
    }
    .fabric-presets {
      display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px;
    }
    .fabric-preset {
      padding: 5px 11px; border-radius: 20px; border: 1px solid var(--border);
      background: var(--surface); font-size: 11px; font-weight: 500;
      cursor: pointer; color: var(--muted); transition: all .2s;
    }
    .fabric-preset:hover { border-color: var(--accent); color: var(--accent); }

    /* CUIDADOS */
    .care-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .care-chip {
      display: flex; align-items: center; gap: 6px; padding: 7px 12px;
      border: 1px solid var(--border); border-radius: 20px; cursor: pointer;
      font-size: 12px; background: var(--surface); color: var(--muted);
      transition: all .2s; user-select: none;
    }
    .care-chip:hover { border-color: var(--accent); color: var(--accent); }
    .care-chip.selected { background: rgba(201,169,110,.1); border-color: var(--accent); color: var(--accent); }
    .care-chip i { font-size: 14px; }

    /* CHIPS ETIQUETAS */
    .tag-input-wrap {
      display: flex; flex-wrap: wrap; gap: 6px; padding: 8px;
      border: 1.5px solid var(--border); border-radius: var(--radius);
      background: var(--bg); min-height: 44px; cursor: text;
      transition: border-color .2s;
    }
    .tag-input-wrap:focus-within { border-color: var(--accent); background: var(--surface); }
    .tag-chip {
      display: flex; align-items: center; gap: 5px; padding: 3px 10px;
      background: rgba(201,169,110,.15); color: var(--accent); border-radius: 20px;
      font-size: 12px; font-weight: 500;
    }
    .tag-chip button { background: none; border: none; cursor: pointer; color: inherit; padding: 0; font-size: 11px; }
    .tag-input {
      border: none; outline: none; background: none; font-family: var(--sans);
      font-size: 13px; color: var(--text); min-width: 100px; flex: 1;
    }
    .tag-input::placeholder { color: var(--muted); }

    /* SORT INDICATOR */
    .sort-indicator {
      display: flex; gap: 8px; align-items: center; margin-left: auto;
      font-size: 12px; color: var(--muted);
    }
    .sort-btn {
      padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px;
      background: var(--surface); font-size: 11px; font-weight: 500; cursor: pointer;
      font-family: var(--sans); color: var(--muted); transition: all .2s;
    }
    .sort-btn.active, .sort-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* BULK ACTIONS */
    .bulk-bar {
      background: #1a1a17; color: #fff; border-radius: var(--radius);
      padding: 12px 18px; margin-bottom: 16px; display: none;
      align-items: center; gap: 12px; flex-wrap: wrap;
    }
    .bulk-bar.show { display: flex; }
    .bulk-count { font-size: 13px; }
    .bulk-count strong { color: var(--accent); }

    /* SELECT CHECKBOX ON CARD */
    .card-select-chk {
      position: absolute; top: 10px; right: 52px; z-index: 3;
      width: 20px; height: 20px; accent-color: var(--accent);
      cursor: pointer; display: none;
    }
    .select-mode .card-select-chk { display: block; }
    .prod-card.selected-card { outline: 2px solid var(--accent); }

    /* ‚îÄ‚îÄ‚îÄ FABRIC ACORDEONES ‚îÄ‚îÄ‚îÄ */
    .fab-group {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface);
    }
    .fab-group-head {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      list-style: none;
      user-select: none;
      background: var(--bg);
      transition: background .15s;
    }
    .fab-group-head::-webkit-details-marker { display: none; }
    .fab-group-head:hover { background: rgba(201,169,110,.07); }
    .fab-group-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    .fab-group-sum {
      margin-left: auto;
      font-size: 11px; font-weight: 700;
      color: var(--accent);
      background: rgba(201,169,110,.12);
      padding: 2px 8px; border-radius: 20px;
      min-width: 32px; text-align: center;
    }
    .fab-group-sum.empty { color: var(--muted); background: none; }
    .fab-group-arrow {
      font-size: 10px; color: var(--muted);
      transition: transform .25s;
      flex-shrink: 0;
    }
    details.fab-group[open] .fab-group-arrow { transform: rotate(180deg); }
    .fab-group-body {
      padding: 8px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .fab-group-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 6px;
      border-radius: 6px;
      transition: background .15s;
    }
    .fab-group-row:hover { background: rgba(201,169,110,.06); }
    .fab-group-row.has-val { background: rgba(201,169,110,.1); }
    .fab-lbl {
      width: 130px; flex-shrink: 0;
      font-size: 12px; font-weight: 600; color: var(--text);
    }
    .fab-sub {
      width: 130px; flex-shrink: 0;
      font-size: 10px; color: var(--muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .fab-slider-w { flex: 1; }
    .fab-slider-w .fabric-slider { width: 100%; }
    @media(max-width:640px) {
      .fab-sub { display: none; }
      .fab-lbl { width: 100px; }
    }

    /* PRINT LABEL */
    @media print {
      .topbar, .toolbar, .stats-panel, .save-banner, .add-card { display: none !important; }
    }

    @media(max-width:640px){
      .topbar { padding:0 16px; flex-wrap:wrap; height:auto; padding:12px; gap:10px; }
      .topbar-left, .topbar-right { width:100%; justify-content:space-between; }
      .page { padding:20px 14px; }
      .prod-grid { grid-template-columns:repeat(2,1fr); gap:10px; }
      .form-grid { grid-template-columns:1fr; }
      .cat-tabs { display:none; }
      .stats-panel { grid-template-columns:1fr 1fr; }
      .preview-card { display:none; }
      .modal-tabs { overflow-x: auto; white-space: nowrap; }
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Bara &amp; Co</div>
    <p class="login-sub">Panel de administraci√≥n</p>
    <div class="login-field">
      <label>Contrase√±a</label>
      <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <p class="login-err" id="loginErr"></p>
    <button class="login-btn" onclick="doLogin()">Ingresar</button>
    <p class="login-hint"><i class="fas fa-lock"></i> &nbsp;Acceso exclusivo para administradores</p>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">Bara &amp; Co</div>
    <div class="topbar-tag">Admin avanzado</div>
  </div>
  <div class="topbar-stats" id="statsHeader">
    <span class="stat-item"><i class="fas fa-box"></i> <span id="statTotal">0</span></span>
    <span class="stat-item"><i class="fas fa-eye"></i> <span id="statVisible">0</span></span>
    <span class="stat-item"><i class="fas fa-tag"></i> <span id="statSale">0</span></span>
  </div>
  <div class="topbar-right">
    <div class="import-export">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()" title="Exportar a CSV">
        <i class="fas fa-file-export"></i>
      </button>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importFile').click()" title="Importar CSV">
        <i class="fas fa-file-import"></i>
      </button>
      <input type="file" id="importFile" accept=".csv,.json" style="display:none" onchange="importFile(event)"/>
    </div>
    <a href="tienda.html" target="_blank" class="btn btn-ghost btn-sm">
      <i class="fas fa-store"></i> Ver tienda
    </a>
    <button class="btn btn-ghost btn-sm" onclick="openConfig()" title="Configuraci√≥n">
      <i class="fas fa-cog"></i>
    </button>
    <button class="btn btn-ghost btn-sm" onclick="logout()" title="Cerrar sesi√≥n">
      <i class="fas fa-sign-out-alt"></i>
    </button>
    <button class="btn btn-primary" onclick="openModal()" style="font-size:13px;padding:9px 18px;display:flex;align-items:center;gap:7px;">
      <i class="fas fa-plus"></i> Nuevo producto
    </button>
  </div>
</div>

<!-- PAGE -->
<div class="page">

  <!-- Estad√≠sticas r√°pidas -->
  <div class="stats-panel" id="statsPanel">
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-box"></i></div>
      <div class="stat-content">
        <h3 id="statTotal2">0</h3>
        <p>Total productos</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-eye"></i></div>
      <div class="stat-content">
        <h3 id="statVisible2">0</h3>
        <p>Visibles</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-tag"></i></div>
      <div class="stat-content">
        <h3 id="statSale2">0</h3>
        <p>En oferta</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
      <div class="stat-content">
        <h3 id="statNew">0</h3>
        <p>New Collection</p>
      </div>
    </div>
  </div>

  <!-- Banner cambios sin publicar -->
  <div class="save-banner" id="saveBanner">
    <div class="save-banner-txt">
      <strong id="bannerCount">1 cambio</strong> sin publicar en la tienda
      <small>Los cambios se guardan cuando presion√°s "Publicar"</small>
    </div>
    <button class="btn btn-primary" onclick="publish()" id="publishBtn">
      <i class="fas fa-cloud-upload-alt"></i> Publicar ahora
    </button>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Buscar por nombre, marca, SKU, tipo de prenda..." id="searchInput" oninput="renderGrid()"/>
    </div>
    <div class="cat-tabs">
      <div class="cat-tab active" onclick="setFilter(this,'')">Todos</div>
      <div class="cat-tab" onclick="setFilter(this,'new')">‚ú® New</div>
      <div class="cat-tab" onclick="setFilter(this,'hombre')">üëî Hombre</div>
      <div class="cat-tab" onclick="setFilter(this,'mujer')">üëó Mujer</div>
      <div class="cat-tab" onclick="setFilter(this,'accesorios')">üëú Accesorios</div>
      <div class="cat-tab" onclick="setFilter(this,'lentes')">üï∂Ô∏è Lentes</div>
      <div class="cat-tab" onclick="setFilter(this,'bijouterie')">üíç Bijouterie</div>
      <div class="cat-tab" onclick="setFilter(this,'billeteras')">üëù Billeteras</div>
      <div class="cat-tab" onclick="setFilter(this,'medias')">üß¶ Medias</div>
      <div class="cat-tab" onclick="setFilter(this,'boxers')">ü©≤ Boxers</div>
      <div class="cat-tab" onclick="setFilter(this,'zapatillas')">üëü Zapatillas</div>
      <div class="cat-tab" onclick="setFilter(this,'sale')">üè∑Ô∏è Sale</div>
      <div class="cat-tab" onclick="setFilter(this,'sin-stock')" title="Sin stock">‚ö†Ô∏è Sin stock</div>
    </div>
    <div class="sort-indicator">
      <span>Ordenar:</span>
      <button class="sort-btn active" onclick="setSort(this,'recent')">Reciente</button>
      <button class="sort-btn" onclick="setSort(this,'nombre')">A-Z</button>
      <button class="sort-btn" onclick="setSort(this,'precio-asc')">$ ‚Üë</button>
      <button class="sort-btn" onclick="setSort(this,'precio-desc')">$ ‚Üì</button>
    </div>
  </div>

  <!-- Bulk bar -->
  <div class="bulk-bar" id="bulkBar">
    <span class="bulk-count"><strong id="bulkCount">0</strong> seleccionados</span>
    <button class="btn btn-ghost btn-sm" onclick="bulkToggleActive(true)"><i class="fas fa-eye"></i> Mostrar todos</button>
    <button class="btn btn-ghost btn-sm" onclick="bulkToggleActive(false)"><i class="fas fa-eye-slash"></i> Ocultar todos</button>
    <button class="btn btn-danger btn-sm" onclick="bulkDelete()"><i class="fas fa-trash"></i> Eliminar seleccionados</button>
    <button class="btn btn-ghost btn-sm" onclick="clearSelection()" style="margin-left:auto"><i class="fas fa-times"></i> Cancelar</button>
  </div>

  <!-- Grid -->
  <div class="prod-grid" id="prodGrid"></div>

</div>

<!-- MODAL PRODUCTO (MEJORADO) -->
<div class="backdrop" id="mProd" onclick="onBd(event,'mProd',closeModal)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2 class="modal-title" id="modalTitle">Nuevo producto</h2>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>

    <!-- TABS -->
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab(this,'tab-basic')"><i class="fas fa-info-circle"></i> B√°sico</button>
      <button class="modal-tab" onclick="switchTab(this,'tab-material')"><i class="fas fa-tshirt"></i> Material</button>
      <button class="modal-tab" onclick="switchTab(this,'tab-stock')"><i class="fas fa-boxes"></i> Stock</button>
      <button class="modal-tab" onclick="switchTab(this,'tab-media')"><i class="fas fa-images"></i> Fotos</button>
      <button class="modal-tab" onclick="switchTab(this,'tab-config')"><i class="fas fa-sliders-h"></i> Config</button>
    </div>

    <div class="modal-body">
      <input type="hidden" id="editId"/>

      <!-- ‚ïê‚ïê‚ïê TAB: B√ÅSICO ‚ïê‚ïê‚ïê -->
      <div class="tab-panel active" id="tab-basic">

        <!-- INFORMACI√ìN B√ÅSICA -->
        <div class="form-row">
          <label class="form-label">Nombre del producto *</label>
          <input type="text" class="form-input" id="fNombre" placeholder="ej: Campera LAMPARD"/>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label class="form-label">Precio ($) *</label>
            <input type="number" class="form-input" id="fPrecio" placeholder="75000"/>
          </div>
          <div class="form-row">
            <label class="form-label">Precio anterior</label>
            <input type="number" class="form-input" id="fPrecioAnt" placeholder="Para mostrar descuento"/>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-row">
            <label class="form-label">Categor√≠a *</label>
            <select class="form-select" id="fCat" onchange="updateSubcategorias()">
              <option value="new">‚ú® New Collection</option>
              <option value="hombre">üëî Hombre</option>
              <option value="mujer">üëó Mujer</option>
              <option value="accesorios">üëú Accesorios</option>
            </select>
          </div>
          <div class="form-row">
            <label class="form-label">Subcategor√≠a</label>
            <select class="form-select" id="fSub">
              <option value="">Seleccionar</option>
              <option value="Camperas">Camperas</option>
              <option value="Camisas">Camisas</option>
              <option value="Musculosa">Musculosa</option>
              <option value="Remeras">Remeras</option>
              <option value="Pantalones">Pantalones</option>
              <option value="Buzos">Buzos</option>
              <option value="Conjuntos">Conjuntos</option>
              <option value="Bermudas">Bermudas</option>
              <option value="Shorts">Shorts</option>
              <option value="Polleras">Polleras</option>
              <option value="Vestidos">Vestidos</option>
              <option value="Lentes de sol">üï∂Ô∏è Lentes de sol</option>
              <option value="Bijouterie hombre">üíç Bijouterie hombre</option>
              <option value="Bijouterie mujer">üíç Bijouterie mujer</option>
              <option value="Billeteras">üëù Billeteras</option>
              <option value="Ri√±oneras">üëú Ri√±oneras</option>
              <option value="Medias">üß¶ Medias</option>
              <option value="Boxers">ü©≤ Boxers</option>
              <option value="Zapatillas">üëü Zapatillas</option>
              <option value="Abanicos">Abanicos</option>
              <option value="Gorras">Gorras</option>
              <option value="Cintos">Cintos</option>
              <option value="Pilusos">Pilusos</option>
            </select>
          </div>
        </div>

        <!-- DESCRIPCI√ìN -->
        <div class="form-row">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-textarea" id="fDesc" placeholder="Descripci√≥n del producto..."></textarea>
          <div class="form-hint"><i class="fas fa-info-circle"></i> Se mostrar√° en la p√°gina de producto</div>
        </div>

        <!-- MARCA -->
        <div class="form-row">
          <label class="form-label"><i class="fas fa-copyright" style="color:var(--accent);margin-right:4px"></i> Marca / Etiqueta de prenda</label>
          <input type="text" class="form-input" id="fMarca" placeholder="ej: Bara &amp; Co, Lacoste, Nike, Sin marca..."/>
          <div class="form-hint"><i class="fas fa-tag"></i> La marca que aparece en la etiqueta cosida de la prenda. Se muestra en la ficha del producto.</div>
        </div>

        <!-- KEYWORDS DE B√öSQUEDA -->
        <div class="form-row">
          <label class="form-label"><i class="fas fa-search" style="color:var(--accent);margin-right:4px"></i> Keywords de b√∫squeda</label>
          <div class="tag-input-wrap" id="tagWrap" onclick="document.getElementById('tagInput').focus()">
            <input type="text" class="tag-input" id="tagInput" placeholder="Escrib√≠ y presion√° Enter..." onkeydown="addTag(event)"/>
          </div>
          <div class="form-hint"><i class="fas fa-info-circle"></i> Palabras para b√∫squedas internas (ej: verano, oversize, casual). No confundir con la marca ‚Äî eso va arriba.</div>
        </div>

        <!-- TEMPORADA / G√âNERO -->
        <div class="form-grid">
          <div class="form-row">
            <label class="form-label">Temporada</label>
            <select class="form-select" id="fTemporada">
              <option value="">Sin especificar</option>
              <option value="verano">‚òÄÔ∏è Verano</option>
              <option value="invierno">‚ùÑÔ∏è Invierno</option>
              <option value="primavera">üå∏ Primavera</option>
              <option value="oto√±o">üçÇ Oto√±o</option>
              <option value="all-season">üîÑ Todo el a√±o</option>
            </select>
          </div>
          <div class="form-row">
            <label class="form-label">G√©nero</label>
            <select class="form-select" id="fGenero">
              <option value="">Sin especificar</option>
              <option value="masculino">Masculino</option>
              <option value="femenino">Femenino</option>
              <option value="unisex">Unisex</option>
            </select>
          </div>
        </div>

        <!-- SKU / C√ìDIGO -->
        <div class="form-row">
          <label class="form-label">SKU / C√≥digo interno</label>
          <input type="text" class="form-input" id="fSku" placeholder="ej: CAM-001-NEG"/>
          <div class="form-hint"><i class="fas fa-info-circle"></i> C√≥digo de referencia propio (no visible en tienda)</div>
        </div>

      </div><!-- /tab-basic -->

      <!-- ‚ïê‚ïê‚ïê TAB: MATERIAL ‚ïê‚ïê‚ïê -->
      <div class="tab-panel" id="tab-material">

        <!-- COMPOSICI√ìN DE TELA -->
        <div class="fabric-section">
          <div class="fabric-title">
            <i class="fas fa-tshirt" style="color:var(--accent)"></i>
            Composici√≥n de tela
            <span class="fabric-total-badge partial" id="fabricTotal">0%</span>
          </div>

          <!-- Barra visual de composici√≥n -->
          <div class="fabric-bar-visual" id="fabricBarVisual" style="margin-bottom:16px;"></div>

          <!-- ACORDEONES POR CATEGOR√çA -->
          <div id="fabricRows" style="display:flex;flex-direction:column;gap:4px;">

            <!-- 1. Fibras Naturales Vegetales -->
            <details class="fab-group" open>
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#c9a96e"></span>
                üåø Fibras Naturales (vegetales)
                <span class="fab-group-sum" id="fgs-vegetal">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="algodon">    <div class="fab-lbl">Algod√≥n</div>    <div class="fab-sub">jersey, popl√≠n, denim, frisa‚Ä¶</div><div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-algodon"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-algodon-pct"    oninput="syncFabricSlider('algodon')"/></div>
                <div class="fab-group-row" data-f="lino">       <div class="fab-lbl">Lino</div>       <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-lino"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-lino-pct"       oninput="syncFabricSlider('lino')"/></div>
                <div class="fab-group-row" data-f="ramio">      <div class="fab-lbl">Ramio</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-ramio"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-ramio-pct"      oninput="syncFabricSlider('ramio')"/></div>
                <div class="fab-group-row" data-f="canhamo">    <div class="fab-lbl">C√°√±amo</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-canhamo"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-canhamo-pct"    oninput="syncFabricSlider('canhamo')"/></div>
                <div class="fab-group-row" data-f="bambu">      <div class="fab-lbl">Bamb√∫</div>      <div class="fab-sub">fibra regenerada natural</div>       <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-bambu"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-bambu-pct"      oninput="syncFabricSlider('bambu')"/></div>
              </div>
            </details>

            <!-- 2. Fibras Naturales Animales -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#c0392b"></span>
                üêë Fibras Naturales (animales)
                <span class="fab-group-sum" id="fgs-animal">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="lana">       <div class="fab-lbl">Lana</div>       <div class="fab-sub">merino, virgen, cardada, peinada</div><div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-lana"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-lana-pct"       oninput="syncFabricSlider('lana')"/></div>
                <div class="fab-group-row" data-f="cashmere">   <div class="fab-lbl">Cashmere</div>   <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-cashmere"   oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-cashmere-pct"   oninput="syncFabricSlider('cashmere')"/></div>
                <div class="fab-group-row" data-f="mohair">     <div class="fab-lbl">Mohair</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-mohair"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-mohair-pct"     oninput="syncFabricSlider('mohair')"/></div>
                <div class="fab-group-row" data-f="alpaca">     <div class="fab-lbl">Alpaca</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-alpaca"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-alpaca-pct"     oninput="syncFabricSlider('alpaca')"/></div>
                <div class="fab-group-row" data-f="angora">     <div class="fab-lbl">Angora</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-angora"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-angora-pct"     oninput="syncFabricSlider('angora')"/></div>
                <div class="fab-group-row" data-f="seda">       <div class="fab-lbl">Seda natural</div><div class="fab-sub"></div>                              <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-seda"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-seda-pct"       oninput="syncFabricSlider('seda')"/></div>
                <div class="fab-group-row" data-f="cuero">      <div class="fab-lbl">Cuero</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-cuero"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-cuero-pct"      oninput="syncFabricSlider('cuero')"/></div>
                <div class="fab-group-row" data-f="gamuza">     <div class="fab-lbl">Gamuza</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-gamuza"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-gamuza-pct"     oninput="syncFabricSlider('gamuza')"/></div>
              </div>
            </details>

            <!-- 3. Fibras Sint√©ticas -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#3d6bce"></span>
                üî¨ Fibras Sint√©ticas
                <span class="fab-group-sum" id="fgs-sint">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="poliester">  <div class="fab-lbl">Poli√©ster</div>   <div class="fab-sub"></div>                              <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-poliester"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-poliester-pct"  oninput="syncFabricSlider('poliester')"/></div>
                <div class="fab-group-row" data-f="nylon">      <div class="fab-lbl">Nylon / Poliamida</div><div class="fab-sub"></div>                         <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-nylon"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-nylon-pct"      oninput="syncFabricSlider('nylon')"/></div>
                <div class="fab-group-row" data-f="acilico">    <div class="fab-lbl">Acr√≠lico</div>    <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-acilico"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-acilico-pct"    oninput="syncFabricSlider('acilico')"/></div>
                <div class="fab-group-row" data-f="elastano">   <div class="fab-lbl">Elastano / Spandex / Lycra</div><div class="fab-sub"></div>                 <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-elastano"   oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-elastano-pct"   oninput="syncFabricSlider('elastano')"/></div>
                <div class="fab-group-row" data-f="microfibra">  <div class="fab-lbl">Microfibra</div>  <div class="fab-sub"></div>                              <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-microfibra"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-microfibra-pct"  oninput="syncFabricSlider('microfibra')"/></div>
                <div class="fab-group-row" data-f="poliuretano"> <div class="fab-lbl">Poliuretano (PU)</div><div class="fab-sub">cuerina sint√©tica</div>          <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-poliuretano" oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-poliuretano-pct" oninput="syncFabricSlider('poliuretano')"/></div>
              </div>
            </details>

            <!-- 4. Fibras Artificiales -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#8e44ad"></span>
                üçÉ Fibras Artificiales (celulosa)
                <span class="fab-group-sum" id="fgs-artif">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="viscosa">    <div class="fab-lbl">Viscosa / Ray√≥n</div><div class="fab-sub"></div>                            <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-viscosa"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-viscosa-pct"    oninput="syncFabricSlider('viscosa')"/></div>
                <div class="fab-group-row" data-f="modal">      <div class="fab-lbl">Modal</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-modal"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-modal-pct"      oninput="syncFabricSlider('modal')"/></div>
                <div class="fab-group-row" data-f="lyocell">    <div class="fab-lbl">Lyocell (Tencel)</div><div class="fab-sub"></div>                          <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-lyocell"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-lyocell-pct"    oninput="syncFabricSlider('lyocell')"/></div>
                <div class="fab-group-row" data-f="acetato">    <div class="fab-lbl">Acetato</div>    <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-acetato"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-acetato-pct"    oninput="syncFabricSlider('acetato')"/></div>
              </div>
            </details>

            <!-- 5. Tejidos Planos -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#2c3e50"></span>
                üßµ Tejidos Planos
                <span class="fab-group-sum" id="fgs-plano">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="popelin">    <div class="fab-lbl">Popl√≠n</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-popelin"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-popelin-pct"    oninput="syncFabricSlider('popelin')"/></div>
                <div class="fab-group-row" data-f="sarga">      <div class="fab-lbl">Sarga</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-sarga"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-sarga-pct"      oninput="syncFabricSlider('sarga')"/></div>
                <div class="fab-group-row" data-f="gabardina">  <div class="fab-lbl">Gabardina</div>  <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-gabardina"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-gabardina-pct"  oninput="syncFabricSlider('gabardina')"/></div>
                <div class="fab-group-row" data-f="denim">      <div class="fab-lbl">Denim</div>      <div class="fab-sub">con o sin elastano</div>             <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-denim"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-denim-pct"      oninput="syncFabricSlider('denim')"/></div>
                <div class="fab-group-row" data-f="tafeta">     <div class="fab-lbl">Tafeta</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-tafeta"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-tafeta-pct"     oninput="syncFabricSlider('tafeta')"/></div>
                <div class="fab-group-row" data-f="saten">      <div class="fab-lbl">Sat√©n</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-saten"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-saten-pct"      oninput="syncFabricSlider('saten')"/></div>
                <div class="fab-group-row" data-f="crepe">      <div class="fab-lbl">Crep√©</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-crepe"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-crepe-pct"      oninput="syncFabricSlider('crepe')"/></div>
                <div class="fab-group-row" data-f="gasa">       <div class="fab-lbl">Gasa</div>       <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-gasa"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-gasa-pct"       oninput="syncFabricSlider('gasa')"/></div>
                <div class="fab-group-row" data-f="oxford">     <div class="fab-lbl">Oxford</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-oxford"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-oxford-pct"     oninput="syncFabricSlider('oxford')"/></div>
                <div class="fab-group-row" data-f="twill">      <div class="fab-lbl">Twill</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-twill"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-twill-pct"      oninput="syncFabricSlider('twill')"/></div>
                <div class="fab-group-row" data-f="lona">       <div class="fab-lbl">Lona</div>       <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-lona"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-lona-pct"       oninput="syncFabricSlider('lona')"/></div>
                <div class="fab-group-row" data-f="jacquard">   <div class="fab-lbl">Jacquard / Brocato</div><div class="fab-sub"></div>                        <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-jacquard"   oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-jacquard-pct"   oninput="syncFabricSlider('jacquard')"/></div>
              </div>
            </details>

            <!-- 6. Tejidos de Punto -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#00b894"></span>
                üß∂ Tejidos de Punto
                <span class="fab-group-sum" id="fgs-punto">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="jersey">     <div class="fab-lbl">Jersey</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-jersey"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-jersey-pct"     oninput="syncFabricSlider('jersey')"/></div>
                <div class="fab-group-row" data-f="interlock">  <div class="fab-lbl">Interlock</div>  <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-interlock"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-interlock-pct"  oninput="syncFabricSlider('interlock')"/></div>
                <div class="fab-group-row" data-f="rib">        <div class="fab-lbl">Rib</div>        <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-rib"        oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-rib-pct"        oninput="syncFabricSlider('rib')"/></div>
                <div class="fab-group-row" data-f="morley">     <div class="fab-lbl">Morley / French Terry</div><div class="fab-sub"></div>                     <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-morley"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-morley-pct"     oninput="syncFabricSlider('morley')"/></div>
                <div class="fab-group-row" data-f="pique">      <div class="fab-lbl">Piqu√©</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-pique"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-pique-pct"      oninput="syncFabricSlider('pique')"/></div>
                <div class="fab-group-row" data-f="frisa">      <div class="fab-lbl">Frisa / Polar</div><div class="fab-sub"></div>                             <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-frisa"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-frisa-pct"      oninput="syncFabricSlider('frisa')"/></div>
                <div class="fab-group-row" data-f="plush">      <div class="fab-lbl">Plush</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-plush"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-plush-pct"      oninput="syncFabricSlider('plush')"/></div>
                <div class="fab-group-row" data-f="waffle">     <div class="fab-lbl">Waffle</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-waffle"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-waffle-pct"     oninput="syncFabricSlider('waffle')"/></div>
                <div class="fab-group-row" data-f="ptoroma">    <div class="fab-lbl">Punto Roma</div> <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-ptoroma"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-ptoroma-pct"    oninput="syncFabricSlider('ptoroma')"/></div>
              </div>
            </details>

            <!-- 7. Telas T√©cnicas / Deportivas -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#0984e3"></span>
                ‚ö° T√©cnicas / Deportivas
                <span class="fab-group-sum" id="fgs-tec">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="dryfit">     <div class="fab-lbl">Dry Fit</div>    <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-dryfit"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-dryfit-pct"     oninput="syncFabricSlider('dryfit')"/></div>
                <div class="fab-group-row" data-f="supplex">    <div class="fab-lbl">Supplex</div>    <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-supplex"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-supplex-pct"    oninput="syncFabricSlider('supplex')"/></div>
                <div class="fab-group-row" data-f="neoprene">   <div class="fab-lbl">Neoprene</div>   <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-neoprene"   oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-neoprene-pct"   oninput="syncFabricSlider('neoprene')"/></div>
                <div class="fab-group-row" data-f="softshell">  <div class="fab-lbl">Softshell</div>  <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-softshell"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-softshell-pct"  oninput="syncFabricSlider('softshell')"/></div>
                <div class="fab-group-row" data-f="ripstop">    <div class="fab-lbl">Ripstop</div>    <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-ripstop"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-ripstop-pct"    oninput="syncFabricSlider('ripstop')"/></div>
                <div class="fab-group-row" data-f="powermesh">  <div class="fab-lbl">Power Mesh</div> <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-powermesh"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-powermesh-pct"  oninput="syncFabricSlider('powermesh')"/></div>
              </div>
            </details>

            <!-- 8. Elegantes / Alta Moda -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#a29bfe"></span>
                ‚ú® Elegantes / Alta Moda
                <span class="fab-group-sum" id="fgs-elegan">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="tul">        <div class="fab-lbl">Tul</div>        <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-tul"        oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-tul-pct"        oninput="syncFabricSlider('tul')"/></div>
                <div class="fab-group-row" data-f="encaje">     <div class="fab-lbl">Encaje / Chantilly</div><div class="fab-sub"></div>                        <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-encaje"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-encaje-pct"     oninput="syncFabricSlider('encaje')"/></div>
                <div class="fab-group-row" data-f="guipur">     <div class="fab-lbl">G√ºip√ºr</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-guipur"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-guipur-pct"     oninput="syncFabricSlider('guipur')"/></div>
                <div class="fab-group-row" data-f="terciopelo"> <div class="fab-lbl">Terciopelo</div> <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-terciopelo" oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-terciopelo-pct" oninput="syncFabricSlider('terciopelo')"/></div>
                <div class="fab-group-row" data-f="pana">       <div class="fab-lbl">Pana</div>       <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-pana"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-pana-pct"       oninput="syncFabricSlider('pana')"/></div>
                <div class="fab-group-row" data-f="organza">    <div class="fab-lbl">Organza / Chiffon</div><div class="fab-sub"></div>                         <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-organza"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-organza-pct"    oninput="syncFabricSlider('organza')"/></div>
                <div class="fab-group-row" data-f="mikado">     <div class="fab-lbl">Mikado / Shantung</div><div class="fab-sub"></div>                         <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-mikado"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-mikado-pct"     oninput="syncFabricSlider('mikado')"/></div>
                <div class="fab-group-row" data-f="lurex">      <div class="fab-lbl">Lurex / Lam√©</div><div class="fab-sub">con hilos met√°licos</div>           <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-lurex"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-lurex-pct"      oninput="syncFabricSlider('lurex')"/></div>
              </div>
            </details>

            <!-- 9. Abrigos -->
            <details class="fab-group">
              <summary class="fab-group-head" onclick="toggleFabGroup(this)">
                <span class="fab-group-dot" style="background:#636e72"></span>
                üß• Telas para Abrigos
                <span class="fab-group-sum" id="fgs-abrigo">‚Äî</span>
                <i class="fas fa-chevron-down fab-group-arrow"></i>
              </summary>
              <div class="fab-group-body">
                <div class="fab-group-row" data-f="pano">       <div class="fab-lbl">Pa√±o</div>       <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-pano"       oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-pano-pct"       oninput="syncFabricSlider('pano')"/></div>
                <div class="fab-group-row" data-f="tweed">      <div class="fab-lbl">Tweed</div>      <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-tweed"      oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-tweed-pct"      oninput="syncFabricSlider('tweed')"/></div>
                <div class="fab-group-row" data-f="boucle">     <div class="fab-lbl">Boucl√©</div>     <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-boucle"     oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-boucle-pct"     oninput="syncFabricSlider('boucle')"/></div>
                <div class="fab-group-row" data-f="corderoy">   <div class="fab-lbl">Corderoy / Pana gruesa</div><div class="fab-sub"></div>                    <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-corderoy"   oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-corderoy-pct"   oninput="syncFabricSlider('corderoy')"/></div>
                <div class="fab-group-row" data-f="fieltro">    <div class="fab-lbl">Fieltro</div>    <div class="fab-sub"></div>                               <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-fieltro"    oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-fieltro-pct"    oninput="syncFabricSlider('fieltro')"/></div>
                <div class="fab-group-row" data-f="micropolar">  <div class="fab-lbl">Micropolar</div> <div class="fab-sub"></div>                              <div class="fab-slider-w"><input type="range" class="fabric-slider" min="0" max="100" value="0" id="fab-micropolar"  oninput="updateFabric()"/></div><input type="number" class="fabric-pct" min="0" max="100" value="0" id="fab-micropolar-pct"  oninput="syncFabricSlider('micropolar')"/></div>
              </div>
            </details>

          </div><!-- /fabricRows -->

          <!-- Presets r√°pidos -->
          <div class="fabric-presets" style="margin-top:14px;">
            <span style="font-size:11px;color:var(--muted);margin-right:4px;line-height:28px;">Presets:</span>
            <button class="fabric-preset" onclick="applyFabricPreset({algodon:100})">100% Algod√≥n</button>
            <button class="fabric-preset" onclick="applyFabricPreset({poliester:100})">100% Poli√©ster</button>
            <button class="fabric-preset" onclick="applyFabricPreset({algodon:95,elastano:5})">Algod√≥n/Elastano 95/5</button>
            <button class="fabric-preset" onclick="applyFabricPreset({algodon:80,poliester:20})">Algod√≥n/Poli√©ster 80/20</button>
            <button class="fabric-preset" onclick="applyFabricPreset({denim:98,elastano:2})">Denim 98/2</button>
            <button class="fabric-preset" onclick="applyFabricPreset({algodon:60,denim:35,elastano:5})">Jean cl√°sico</button>
            <button class="fabric-preset" onclick="applyFabricPreset({viscosa:70,poliester:25,elastano:5})">Viscosa 70/25/5</button>
            <button class="fabric-preset" onclick="applyFabricPreset({elastano:88,poliester:12})">Lycra 88/12</button>
            <button class="fabric-preset" onclick="applyFabricPreset({lana:80,nylon:20})">Lana/Nylon 80/20</button>
            <button class="fabric-preset" onclick="applyFabricPreset({lino:55,algodon:45})">Lino/Algod√≥n 55/45</button>
            <button class="fabric-preset" onclick="applyFabricPreset({seda:100})">100% Seda</button>
            <button class="fabric-preset" onclick="applyFabricPreset({micropolar:100})">100% Micropolar</button>
            <button class="fabric-preset" onclick="applyFabricPreset({cuero:100})">100% Cuero</button>
            <button class="fabric-preset" onclick="clearFabric()"><i class="fas fa-undo" style="font-size:10px"></i> Limpiar</button>
          </div>

          <input type="hidden" id="fFabrica"/>
        </div>

        <!-- CUIDADOS -->
        <div class="form-row">
          <label class="form-label"><i class="fas fa-hands-wash" style="color:var(--accent);margin-right:4px"></i> Instrucciones de cuidado</label>
          <div class="care-grid" id="careGrid">
            <div class="care-chip" onclick="toggleCare(this)" data-care="Lavar a mano"><i class="fas fa-hand-holding-water"></i> Lavar a mano</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="M√°quina agua fr√≠a"><i class="fas fa-tint"></i> M√°quina fr√≠a</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="Lavar en fr√≠o 30¬∞"><i class="fas fa-thermometer-quarter"></i> 30¬∞C</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="No usar secadora"><i class="fas fa-ban"></i> No secadora</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="Secar a la sombra"><i class="fas fa-cloud-sun"></i> Sombra</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="No planchar"><i class="fas fa-ban"></i> No planchar</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="Planchar a baja temperatura"><i class="fas fa-temperature-low"></i> Planchar suave</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="No usar blanqueadores"><i class="fas fa-minus-circle"></i> Sin blanqueador</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="Lavar al rev√©s"><i class="fas fa-sync-alt"></i> Al rev√©s</div>
            <div class="care-chip" onclick="toggleCare(this)" data-care="Dry clean only"><i class="fas fa-shield-alt"></i> Dry clean</div>
          </div>
          <input type="hidden" id="fCuidados"/>
        </div>

        <!-- PESO / DETALLES -->
        <div class="form-grid">
          <div class="form-row">
            <label class="form-label">Peso aprox. (gramos)</label>
            <input type="number" class="form-input" id="fPeso" placeholder="ej: 350" min="0"/>
            <div class="form-hint"><i class="fas fa-info-circle"></i> √ötil para calcular env√≠os</div>
          </div>
          <div class="form-row">
            <label class="form-label">Pa√≠s de origen</label>
            <select class="form-select" id="fOrigen">
              <option value="">Sin especificar</option>
              <option value="Argentina">üá¶üá∑ Argentina</option>
              <option value="Brasil">üáßüá∑ Brasil</option>
              <option value="China">üá®üá≥ China</option>
              <option value="Bangladesh">üáßüá© Bangladesh</option>
              <option value="India">üáÆüá≥ India</option>
              <option value="Per√∫">üáµüá™ Per√∫</option>
              <option value="Colombia">üá®üá¥ Colombia</option>
              <option value="Italia">üáÆüáπ Italia</option>
              <option value="Portugal">üáµüáπ Portugal</option>
              <option value="Turqu√≠a">üáπüá∑ Turqu√≠a</option>
            </select>
          </div>
        </div>

      </div><!-- /tab-material -->

      <!-- ‚ïê‚ïê‚ïê TAB: STOCK ‚ïê‚ïê‚ïê -->
      <div class="tab-panel" id="tab-stock">

        <!-- GESTI√ìN DE COLORES con picker real -->
        <div class="sizes-section" id="colorSection">
          <div class="section-title">
            <i class="fas fa-palette"></i> Colores disponibles
            <span style="font-size:11px;color:var(--muted);margin-left:auto">Seleccion√° los colores del producto</span>
          </div>
          <div class="color-options" id="colorsContainer"></div>
          <div class="cpicker" id="colorPicker">
            <div class="cp-gradient" id="cpGradient">
              <div class="cp-cursor" id="cpCursor"></div>
            </div>
            <div class="cp-sliders">
              <div class="cp-eyedrop" title="Ver hex actual">
                <div class="cp-preview" id="cpPreview"></div>
              </div>
              <div class="cp-slider-col">
                <input type="range" class="cp-hue" id="cpHue" min="0" max="360" value="0"/>
              </div>
            </div>
            <div class="cp-bottom">
              <input class="cp-hex" id="cpHex" maxlength="7" placeholder="#000000"/>
              <input class="cp-name-input" id="cpName" placeholder="Nombre del color (ej: Bordo)"/>
              <button class="cp-add-btn" onclick="cpAddColor()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
          </div>
        </div>

        <!-- GESTI√ìN DE TALLES -->
        <div class="sizes-section">
          <div class="section-title">
            <i class="fas fa-ruler"></i> Talles disponibles
            <span style="font-size:11px;color:var(--muted);margin-left:auto">Marc√° los que tiene este producto</span>
          </div>
          <div class="size-options" id="sizesContainer"></div>
          <div class="form-hint"><i class="fas fa-info-circle"></i> Pod√©s agregar talles personalizados como "36", "√önico", etc.</div>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <input type="text" class="form-input" id="customSize" placeholder="Agregar talle personalizado" style="flex:1"/>
            <button class="btn btn-ghost btn-sm" onclick="addCustomSize()">Agregar</button>
          </div>
        </div>

        <!-- STOCK POR TALLE (sin colores) -->
        <div class="sizes-section" id="stockTallesSection" style="display:none">
          <div class="section-title">
            <i class="fas fa-layer-group"></i> Stock por talle
            <span style="font-size:11px;color:var(--muted);margin-left:auto">Ingres√° la cantidad disponible de cada talle</span>
          </div>
          <div id="stockTallesWrap" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;"></div>
        </div>

        <!-- GRILLA DE STOCK por color √ó talle -->
        <div class="sizes-section" id="stockGridSection" style="display:none">
          <div class="section-title">
            <i class="fas fa-boxes"></i> Stock por color y talle
            <span style="font-size:11px;color:var(--muted);margin-left:auto">Ingres√° la cantidad disponible de cada combinaci√≥n</span>
          </div>
          <div id="stockGridWrap" style="overflow-x:auto;"></div>
        </div>

        <!-- UNIDADES EN STOCK -->
        <div class="form-row">
          <label class="form-label"><i class="fas fa-warehouse" style="color:var(--accent);margin-right:4px;"></i> Unidades en stock (total)</label>
          <div class="form-grid">
            <div>
              <input type="number" class="form-input" id="fStock" min="0" placeholder="ej: 15" oninput="updateStockLabel()"/>
              <div class="form-hint"><i class="fas fa-info-circle"></i> Cantidad total disponible del producto</div>
            </div>
            <div style="display:flex;align-items:center;">
              <div id="stockStatusBadge" style="display:none;padding:8px 14px;border-radius:var(--radius);font-size:13px;font-weight:500;"></div>
            </div>
          </div>
        </div>

      </div><!-- /tab-stock -->

      <!-- ‚ïê‚ïê‚ïê TAB: FOTOS ‚ïê‚ïê‚ïê -->
      <div class="tab-panel" id="tab-media">

        <!-- M√öLTIPLES IM√ÅGENES -->
        <div class="sizes-section">
          <div class="section-title">
            <i class="fas fa-images"></i> Im√°genes del producto
          </div>
          <div class="img-upload-zone" id="dropZone" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
            <input type="file" id="fileInput" accept="image/*" onchange="onFileSelect(event)"
              style="position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:10;"/>
            <div class="upload-idle" id="uploadIdle">
              <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
              <div class="upload-title">Toc√° para elegir una foto</div>
              <div class="upload-sub">o arrastr√° y solt√° desde tu compu</div>
              <div class="upload-formats">JPG ¬∑ PNG ¬∑ WEBP ¬∑ hasta 10MB</div>
            </div>
            <div class="upload-preview" id="uploadPreview" style="display:none;position:relative;z-index:5;">
              <img id="imgPrev" src="" alt="" style="width:100%;max-height:260px;object-fit:contain;display:block;background:#f0ede8;"/>
              <div style="position:absolute;top:8px;right:8px;display:flex;gap:6px;z-index:20;">
                <button type="button" onclick="event.stopPropagation();document.getElementById('fileInput').click()" style="background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:20px;padding:6px 12px;font-size:11px;cursor:pointer;font-family:var(--sans);display:flex;align-items:center;gap:5px;"><i class="fas fa-camera"></i> Cambiar</button>
                <button type="button" onclick="event.stopPropagation();clearImage()" style="background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:20px;padding:6px 12px;font-size:11px;cursor:pointer;font-family:var(--sans);display:flex;align-items:center;gap:5px;"><i class="fas fa-times"></i> Quitar</button>
              </div>
              <div class="upload-badge" id="uploadBadge" style="position:absolute;bottom:8px;left:8px;background:var(--green);color:#fff;font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;display:flex;align-items:center;gap:5px;z-index:20;"><i class="fas fa-check"></i> Imagen cargada</div>
            </div>
            <input type="hidden" id="fImg"/>
          </div>
          <details class="url-fallback" id="urlFallback">
            <summary><i class="fas fa-link"></i> O peg√° una URL de imagen</summary>
            <div style="margin-top:10px; display:flex; gap:8px;">
              <input type="url" class="form-input" id="fImgUrl" placeholder="https://..." style="flex:1"/>
              <button class="btn btn-ghost btn-sm" onclick="useUrlImage()">Usar</button>
            </div>
          </details>
          <div style="margin-top:16px;">
            <label class="form-label">Fotos adicionales</label>
            <div class="extra-imgs-grid" id="extraImgsGrid">
              <div class="extra-add-btn" onclick="abrirSelectorFotoExtra()">
                <i class="fas fa-plus"></i>
                <span>Agregar</span>
              </div>
            </div>
            <input type="hidden" id="fImagenes"/>
          </div>
        </div>

      </div><!-- /tab-media -->

      <!-- ‚ïê‚ïê‚ïê TAB: CONFIG ‚ïê‚ïê‚ïê -->
      <div class="tab-panel" id="tab-config">

        <!-- VISIBILIDAD -->
        <div class="form-row">
          <label class="form-label">Estado y visibilidad</label>
          <div style="display:flex;align-items:center;gap:20px;margin-top:6px; flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:10px;">
              <span style="font-size:13px;">Visible en tienda</span>
              <label class="toggle">
                <input type="checkbox" id="fActivo" checked onchange="updActivoLabel()"/>
                <div class="t-track"></div><div class="t-thumb"></div>
              </label>
            </label>
            <span id="activoLbl" style="font-size:13px;color:var(--green)">S√≠, se muestra</span>

            <label style="display:flex;align-items:center;gap:10px;">
              <span style="font-size:13px;">Destacar en inicio</span>
              <label class="toggle">
                <input type="checkbox" id="fDestacado"/>
                <div class="t-track"></div><div class="t-thumb"></div>
              </label>
            </label>

            <label style="display:flex;align-items:center;gap:10px;">
              <span style="font-size:13px;color:#e07b39;">üè∑Ô∏è Outlet</span>
              <label class="toggle toggle-outlet">
                <input type="checkbox" id="fOutlet"/>
                <div class="t-track"></div><div class="t-thumb"></div>
              </label>
            </label>
          </div>
        </div>

        <!-- PROVEEDOR -->
        <div class="form-row">
          <label class="form-label"><i class="fas fa-truck" style="color:var(--accent);margin-right:4px"></i> Proveedor</label>
          <input type="text" class="form-input" id="fProveedor" placeholder="ej: Distribuidora L√≥pez"/>
          <div class="form-hint"><i class="fas fa-info-circle"></i> Solo visible en el panel de admin</div>
        </div>

        <!-- NOTAS INTERNAS -->
        <div class="form-row">
          <label class="form-label"><i class="fas fa-sticky-note" style="color:var(--accent);margin-right:4px"></i> Notas internas</label>
          <textarea class="form-textarea" id="fNotas" placeholder="Notas de uso interno (no se muestra en tienda)..." style="min-height:80px;"></textarea>
        </div>

        <!-- PRECIO DE COSTO -->
        <div class="form-grid">
          <div class="form-row">
            <label class="form-label">Precio de costo ($)</label>
            <input type="number" class="form-input" id="fCosto" placeholder="Para calcular margen" min="0"/>
            <div class="form-hint"><i class="fas fa-eye-slash"></i> Privado, no se muestra en tienda</div>
          </div>
          <div class="form-row" style="display:flex;align-items:center;padding-top:20px;">
            <div id="margenBadge" style="display:none;padding:10px 14px;border-radius:var(--radius);font-size:13px;font-weight:500;background:rgba(45,138,94,.1);color:var(--green);border:1px solid rgba(45,138,94,.2);"></div>
          </div>
        </div>

        <!-- LINK EXTERNO -->
        <div class="form-row">
          <label class="form-label">Link externo (opcional)</label>
          <input type="url" class="form-input" id="fLink" placeholder="https://..."/>
          <div class="form-hint"><i class="fas fa-info-circle"></i> Redirige a la web del fabricante o tienda externa</div>
        </div>

      </div><!-- /tab-config -->

    </div><!-- /modal-body -->

    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-ghost" onclick="duplicateFromModal()" id="duplicateBtn" style="display:none;">
        <i class="fas fa-copy"></i> Duplicar
      </button>
      <button class="btn btn-primary" onclick="saveProduct()"><i class="fas fa-check"></i> Guardar</button>
    </div>
  </div>
</div>

<!-- PREVIEW CARD -->
<div class="preview-card" id="previewCard">
  <div class="preview-img" id="previewImg">
    <img src="" alt="preview"/>
  </div>
  <div class="preview-info">
    <div class="preview-name" id="previewName">Nombre producto</div>
    <div class="preview-price" id="previewPrice">$0</div>
  </div>
</div>

<!-- MODAL CONFIGURACI√ìN -->
<div class="backdrop" id="mCfg" onclick="onBd(event,'mCfg',closeConfig)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2 class="modal-title">Configuraci√≥n</h2>
      <button class="modal-close" onclick="closeConfig()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">üîë Token de GitHub</label>
        <input type="password" class="form-input" id="cfgToken" placeholder="ghp_xxxxxxxxxxxxxxxx"/>
      </div>
      <div class="form-row">
        <label class="form-label">Repositorio</label>
        <input type="text" class="form-input" id="cfgRepo" value="bara-and-co/Bara-Co"/>
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="saveConfig()">
        <i class="fas fa-save"></i> Guardar configuraci√≥n
      </button>
      <div class="cfg-ok" id="cfgOk"><i class="fas fa-check-circle"></i> ¬°Listo! Ya pod√©s publicar cambios.</div>
      <div class="cfg-err" id="cfgErr"></div>

      <details style="margin-top:20px">
        <summary style="cursor:pointer;font-size:13px;color:var(--muted)">¬øC√≥mo obtengo el token?</summary>
        <div class="steps">
          <ol>
            <li>Entr√° a <strong>github.com</strong> ‚Üí clic en tu foto ‚Üí <strong>Settings</strong></li>
            <li>Baj√° hasta <strong>Developer settings</strong> ‚Üí <strong>Personal access tokens ‚Üí Tokens (classic)</strong></li>
            <li>Clic en <strong>Generate new token (classic)</strong></li>
            <li>Nombre: <code>bara-admin</code> ¬∑ Tild√°: <strong>repo</strong> ‚úì</li>
            <li>Clic en <strong>Generate token</strong> ¬∑ Copi√° el token y pegalo arriba</li>
          </ol>
        </div>
      </details>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeConfig()">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Inputs de archivo FUERA del modal para que funcionen en todos los browsers -->
<input type="file" id="extraFileInput" accept="image/*" multiple style="display:none" onchange="onExtraFiles(event)"/>

<script>
/* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
const ADMIN_PASS = 'baraadmin2026';
const SESSION_KEY = 'bc_admin_auth';

function checkAuth() {
  const ok = sessionStorage.getItem(SESSION_KEY) === '1';
  if (ok) {
    document.getElementById('loginScreen').classList.add('hidden');
  } else {
    document.getElementById('loginScreen').classList.remove('hidden');
  }
  return ok;
}

function doLogin() {
  const pass = document.getElementById('loginPass').value;
  if (pass === ADMIN_PASS) {
    sessionStorage.setItem(SESSION_KEY, '1');
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loginErr').textContent = '';
    init();
  } else {
    document.getElementById('loginErr').textContent = 'Contrase√±a incorrecta';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginPass').focus();
  }
}

function logout() {
  sessionStorage.removeItem(SESSION_KEY);
  location.reload();
}

/* ‚îÄ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ‚îÄ */
let products = [];
let filterCat = '';
let pending = 0;
let currentPreviewTimeout;

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
async function init() {
  const t = localStorage.getItem('bc_gh_token') || '';
  const r = localStorage.getItem('bc_gh_repo')  || 'bara-and-co/Bara-Co';
  if (t) document.getElementById('cfgToken').value = t;
  document.getElementById('cfgRepo').value = r;

  // Cargar borrador local primero
  const draft = localStorage.getItem('bc_draft');
  if (draft) { try { products = JSON.parse(draft); } catch(e){} }

  // Si no hay borrador, cargar del repo
  if (!products.length) {
    for (const url of ['productos.json', 'https://bara-and-co.github.io/Bara-Co/productos.json']) {
      try { const res = await fetch(url+'?t='+Date.now()); if(res.ok){ products = await res.json(); break; } } catch(e){}
    }
  }
  renderGrid();
  updateStats();
}

/* ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ */
function renderGrid() {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const grid = document.getElementById('prodGrid');
  grid.innerHTML = '';

  const catMap = { 
    new:'badge-new', 
    hombre:'badge-hom', 
    mujer:'badge-muj', 
    accesorios:'badge-acc',
    lentes:'badge-lentes',
    bijouterie:'badge-bijou',
    billeteras:'badge-billeteras',
    medias:'badge-medias',
    boxers:'badge-boxers',
    zapatillas:'badge-zapatillas'
  };
  
  const catLbl = { 
    new:'New', 
    hombre:'Hombre', 
    mujer:'Mujer', 
    accesorios:'Acces.',
    lentes:'Lentes',
    bijouterie:'Bijou',
    billeteras:'Bille.',
    medias:'Medias',
    boxers:'Boxers',
    zapatillas:'Zapa.'
  };

  let list = products.filter(p =>
    (!q || 
      p.nombre.toLowerCase().includes(q) || 
      (p.tags||[]).join(' ').toLowerCase().includes(q) ||
      (p.subcategoria||'').toLowerCase().includes(q) ||
      (p.marca||'').toLowerCase().includes(q) ||
      (p.sku||'').toLowerCase().includes(q) ||
      (p.descripcion||'').toLowerCase().includes(q)
    ) &&
    (!filterCat || (filterCat === 'sale' ? p.precioAnterior : filterCat === 'sin-stock' ? (p.stock === 0) : p.categoria === filterCat || p.subcategoria === filterCat))
  );

  if (filterCat === 'sale') list = list.filter(p => p.precioAnterior);
  if (filterCat === 'sin-stock') list = list.filter(p => p.stock === 0);

  // Sort
  if (sortMode === 'nombre') list.sort((a,b) => a.nombre.localeCompare(b.nombre));
  else if (sortMode === 'precio-asc') list.sort((a,b) => a.precio - b.precio);
  else if (sortMode === 'precio-desc') list.sort((a,b) => b.precio - a.precio);
  // 'recent' = default array order

  updateStats();

  if (!list.length) {
    grid.innerHTML = '<div class="empty"><i class="fas fa-box-open"></i><p>No hay productos aqu√≠ todav√≠a</p></div>';
  } else {
    list.forEach(p => {
      const disc = p.precioAnterior ? Math.round((1-p.precio/p.precioAnterior)*100)+'%' : null;
      const tallesStr = p.tallesDisponibles?.slice(0,3).join(', ') + (p.tallesDisponibles?.length > 3 ? '...' : '');
      const colores = p.colores?.length || 0;
      
      // Determinar badge seg√∫n subcategor√≠a para accesorios
      let badgeCat = catMap[p.categoria] || 'badge-acc';
      let labelCat = catLbl[p.categoria] || p.categoria;
      
      if (p.categoria === 'accesorios' && p.subcategoria) {
        if (p.subcategoria.includes('Lentes')) {
          badgeCat = 'badge-lentes';
          labelCat = 'Lentes';
        } else if (p.subcategoria.includes('Bijouterie')) {
          badgeCat = 'badge-bijou';
          labelCat = 'Bijou';
        } else if (p.subcategoria.includes('Billetera')) {
          badgeCat = 'badge-billeteras';
          labelCat = 'Bille.';
        } else if (p.subcategoria.includes('Media')) {
          badgeCat = 'badge-medias';
          labelCat = 'Medias';
        } else if (p.subcategoria.includes('Boxer')) {
          badgeCat = 'badge-boxers';
          labelCat = 'Boxers';
        } else if (p.subcategoria.includes('Zapatilla')) {
          badgeCat = 'badge-zapatillas';
          labelCat = 'Zapa.';
        }
      }
      
      const fabricStr = p.fabrica ? Object.entries(p.fabrica).map(([k,v]) => `${v}% ${k.charAt(0).toUpperCase()+k.slice(1)}`).slice(0,2).join(' ¬∑ ') : '';
      const el = document.createElement('div');
      el.className = 'prod-card' + (p.activo === false ? ' inactive' : '') + (selectedIds.has(p.id) ? ' selected-card' : '');
      el.dataset.id = p.id;
      el.innerHTML = `
        <div class="prod-img">
          <input type="checkbox" class="card-select-chk" ${selectedIds.has(p.id)?'checked':''} onclick="event.stopPropagation();toggleSelectCard('${p.id}',this.checked)" title="Seleccionar"/>
          <span class="cat-badge ${badgeCat}">${labelCat}</span>
          ${disc?`<span class="disc-badge">-${disc}</span>`:''}
          <div class="prod-badges">
            ${tallesStr ? `<span class="mini-badge"><i class="fas fa-ruler"></i> ${tallesStr}</span>` : ''}
            ${colores ? `<span class="mini-badge"><i class="fas fa-palette"></i> ${colores}</span>` : ''}
            ${p.temporada ? `<span class="mini-badge"><i class="fas fa-calendar"></i> ${p.temporada}</span>` : ''}
          </div>
          <img src="${p.imagen}" alt="${p.nombre}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22400%22%3E%3Crect fill=%22%23f0ede8%22 width=%22300%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23c9a96e%22 font-size=%2214%22%3ESin imagen%3C/text%3E%3C/svg%3E'"/>
          <div class="prod-overlay">
            <button class="ov-btn" title="Editar" onclick="event.stopPropagation();openModal('${p.id}')"><i class="fas fa-pen"></i></button>
            <button class="ov-btn" title="Vista previa" onclick="event.stopPropagation();previewProduct('${p.id}')"><i class="fas fa-eye"></i></button>
            <button class="ov-btn dup" title="Duplicar" onclick="event.stopPropagation();duplicateProduct('${p.id}')"><i class="fas fa-copy"></i></button>
            <button class="ov-btn del" title="Eliminar" onclick="event.stopPropagation();deleteP('${p.id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="prod-info">
          <div class="prod-name">${p.nombre}</div>
          <div class="prod-price">
            <span class="price-main">$${p.precio.toLocaleString('es-AR')}</span>
            ${p.precioAnterior?`<span class="price-old">$${p.precioAnterior.toLocaleString('es-AR')}</span>`:''}
          </div>
          ${fabricStr ? `<div style="font-size:10px;color:var(--muted);margin-top:4px;"><i class="fas fa-tshirt" style="margin-right:3px"></i>${fabricStr}</div>` : ''}
          ${p.marca ? `<div style="font-size:10px;color:var(--accent);margin-top:3px;font-weight:600;letter-spacing:.02em;"><i class="fas fa-copyright" style="margin-right:3px;font-size:9px;opacity:.8"></i>${p.marca}</div>` : ''}
          ${p.sku ? `<div style="font-size:10px;color:var(--muted);margin-top:2px;font-family:monospace">${p.sku}</div>` : ''}
        </div>
        <div class="prod-footer">
          <span class="prod-footer-label">${p.activo?'‚úì Visible':'Oculto'}</span>
          <label class="toggle">
            <input type="checkbox" ${p.activo?'checked':''} onchange="toggleA('${p.id}',this.checked)"/>
            <div class="t-track"></div><div class="t-thumb"></div>
          </label>
        </div>`;
      grid.appendChild(el);
    });
  }

  // Tarjeta agregar
  if (!q) {
    const add = document.createElement('div');
    add.className = 'add-card';
    add.onclick = () => openModal();
    add.innerHTML = '<i class="fas fa-plus"></i><span>Agregar producto</span>';
    grid.appendChild(add);
  }
}

/* ‚îÄ‚îÄ‚îÄ VISTA PREVIA ‚îÄ‚îÄ‚îÄ */
function previewProduct(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  
  const card = document.getElementById('previewCard');
  document.getElementById('previewImg').querySelector('img').src = p.imagen;
  document.getElementById('previewName').textContent = p.nombre;
  document.getElementById('previewPrice').textContent = '$' + p.precio.toLocaleString('es-AR');
  card.classList.add('show');
  
  clearTimeout(currentPreviewTimeout);
  currentPreviewTimeout = setTimeout(() => card.classList.remove('show'), 3000);
}

/* ‚îÄ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ */
function setFilter(el, cat) {
  filterCat = cat;
  document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderGrid();
}

/* ‚îÄ‚îÄ‚îÄ TOGGLE ACTIVO ‚îÄ‚îÄ‚îÄ */
function toggleA(id, val) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  p.activo = val;
  const card = document.querySelector(`.prod-card[data-id="${id}"]`);
  if (card) {
    card.classList.toggle('inactive', !val);
    const lbl = card.querySelector('.prod-footer-label');
    if (lbl) lbl.textContent = val ? '‚úì Visible' : 'Oculto';
  }
  dirty();
  updateStats();
}

/* ‚îÄ‚îÄ‚îÄ ESTAD√çSTICAS ‚îÄ‚îÄ‚îÄ */
function updateStats() {
  const total = products.length;
  const visible = products.filter(p => p.activo).length;
  const sale = products.filter(p => p.precioAnterior).length;
  const newCat = products.filter(p => p.categoria === 'new').length;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statVisible').textContent = visible;
  document.getElementById('statSale').textContent = sale;
  
  document.getElementById('statTotal2').textContent = total;
  document.getElementById('statVisible2').textContent = visible;
  document.getElementById('statSale2').textContent = sale;
  document.getElementById('statNew').textContent = newCat;
}

/* ‚îÄ‚îÄ‚îÄ MODAL PRODUCTO ‚îÄ‚îÄ‚îÄ */
let editId = null;

function openModal(id = null) {
  editId = id;
  document.getElementById('modalTitle').textContent = id ? 'Editar producto' : 'Nuevo producto';
  document.getElementById('duplicateBtn').style.display = id ? 'inline-flex' : 'none';

  // Reset uploader
  extraImgUrls = [];
  document.getElementById('fImg').value = '';
  document.getElementById('fImagenes').value = '';
  document.getElementById('imgPrev').src = '';
  document.getElementById('uploadIdle').style.display = 'block';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('dropZone').classList.remove('has-image');
  renderExtraImgs([]);

  // Reset new fields
  productTags = [];
  renderTags();
  clearFabric();
  document.querySelectorAll('.care-chip').forEach(c => c.classList.remove('selected'));
  ['fCuidados','fPeso','fProveedor','fNotas','fCosto','fLink','fSku','fMarca'].forEach(f => { const el = document.getElementById(f); if(el) el.value = ''; });
  ['fTemporada','fGenero','fOrigen'].forEach(f => { const el = document.getElementById(f); if(el) el.value = ''; });
  const margenBadge = document.getElementById('margenBadge'); if(margenBadge) margenBadge.style.display='none';

  // Reset to first tab
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('.modal-tab').classList.add('active');
  document.getElementById('tab-basic').classList.add('active');

  // Opciones de talles predefinidas
  const tallesOpciones = ['S', 'M', 'L', 'XL', 'XXL', '36', '38', '40', '42', '44', '46', '48', '√önico'];
  const tallesContainer = document.getElementById('sizesContainer');
  tallesContainer.innerHTML = '';
  tallesOpciones.forEach(t => {
    const chip = document.createElement('div');
    chip.className = 'size-chip';
    chip.innerHTML = `<input type="checkbox" value="${t}"> <span>${t}</span>`;
    chip.querySelector('input').addEventListener('change', buildStockGrid);
    tallesContainer.appendChild(chip);
  });

  // Inicializar color picker
  document.getElementById('colorsContainer').innerHTML = '';
  cpInit();
  const paleta = [
    { name:'Negro', code:'#111111' }, { name:'Blanco', code:'#FFFFFF' },
    { name:'Gris', code:'#9E9E9E' }, { name:'Gris oscuro', code:'#424242' },
    { name:'Crema', code:'#F5F0E8' }, { name:'Beige', code:'#D4B896' },
    { name:'Camel', code:'#C19A6B' }, { name:'Marr√≥n', code:'#795548' },
    { name:'Rojo', code:'#E53935' }, { name:'Bordo', code:'#7B1C2A' },
    { name:'Rosa', code:'#F48FB1' }, { name:'Rosa viejo', code:'#C48B9F' },
    { name:'Salm√≥n', code:'#FF8A65' }, { name:'Naranja', code:'#FB8C00' },
    { name:'Amarillo', code:'#FDD835' }, { name:'Mostaza', code:'#F9A825' },
    { name:'Verde', code:'#43A047' }, { name:'Verde oliva', code:'#827717' },
    { name:'Verde agua', code:'#4DB6AC' }, { name:'Celeste', code:'#81D4FA' },
    { name:'Azul', code:'#1E88E5' }, { name:'Azul marino', code:'#1A237E' },
    { name:'Jean', code:'#5C7FA3' }, { name:'Violeta', code:'#8E24AA' },
    { name:'Lila', code:'#CE93D8' }, { name:'Dorado', code:'#C9A96E' },
    { name:'Plateado', code:'#B0BEC5' },
  ];
  paleta.forEach(c => addColorChip(c.name, c.code, false));

  if (id) {
    const p = products.find(x => x.id === id);
    if (!p) return;
    document.getElementById('fNombre').value   = p.nombre || '';
    document.getElementById('fPrecio').value   = p.precio || '';
    document.getElementById('fPrecioAnt').value= p.precioAnterior || '';
    document.getElementById('fCat').value      = p.categoria || 'hombre';
    document.getElementById('fSub').value      = p.subcategoria || '';
    document.getElementById('fImg').value      = p.imagen || '';
    document.getElementById('fDesc').value     = p.descripcion || '';
    document.getElementById('fImagenes').value = p.imagenes?.join(', ') || '';
    document.getElementById('fActivo').checked = p.activo !== false;
    document.getElementById('fDestacado').checked = p.destacado || false;
    document.getElementById('fOutlet').checked = p.outlet || false;
    // New fields
    if (document.getElementById('fTemporada')) document.getElementById('fTemporada').value = p.temporada || '';
    if (document.getElementById('fGenero')) document.getElementById('fGenero').value = p.genero || '';
    if (document.getElementById('fOrigen')) document.getElementById('fOrigen').value = p.origen || '';
    if (document.getElementById('fPeso')) document.getElementById('fPeso').value = p.peso || '';
    if (document.getElementById('fProveedor')) document.getElementById('fProveedor').value = p.proveedor || '';
    if (document.getElementById('fNotas')) document.getElementById('fNotas').value = p.notas || '';
    if (document.getElementById('fCosto')) document.getElementById('fCosto').value = p.costo || '';
    if (document.getElementById('fLink')) document.getElementById('fLink').value = p.link || '';
    if (document.getElementById('fSku')) document.getElementById('fSku').value = p.sku || '';
    if (document.getElementById('fMarca')) document.getElementById('fMarca').value = p.marca || '';
    // Tags
    productTags = p.tags || []; renderTags();
    // Fabric
    loadFabricData(p.fabrica);
    // Care
    loadCareData(p.cuidados);
    
    // Marcar talles disponibles
    if (p.tallesDisponibles) {
      document.querySelectorAll('#sizesContainer input[type="checkbox"]').forEach(chk => {
        chk.checked = p.tallesDisponibles.includes(chk.value);
      });
    }
    
    // Marcar colores disponibles con su stock
    if (p.colores) {
      document.querySelectorAll('#colorsContainer .color-chip-wrap').forEach(wrap => {
        // colores puede ser array de strings o array de {nombre, stock}
        const colorData = p.colores.find(c => 
          typeof c === 'string' ? c === wrap.dataset.color : c.nombre === wrap.dataset.color
        );
        const sel = !!colorData;
        const stockVal = colorData && typeof colorData === 'object' ? colorData.stock : null;
        wrap.classList.toggle('selected-wrap', sel);
        wrap.querySelector('.color-chip').classList.toggle('selected', sel);
        if (sel && stockVal !== null) {
          const inp = wrap.querySelector('.color-stock-input');
          if (inp) inp.value = stockVal;
        }
      });
    }    
    if (p.imagen) { 
      setMainImage(p.imagen);
    }

    // Cargar stock
    document.getElementById('fStock').value = p.stock !== undefined ? p.stock : '';
    updateStockLabel();

    // Reconstruir grilla de stock y cargar valores guardados
    buildStockGrid();
    if (p.stockMap) loadStockData(p.stockMap);
    if (p.stockTalles) {
      document.querySelectorAll('.stock-talle-input').forEach(inp => {
        const val = p.stockTalles[inp.dataset.talle];
        if (val !== undefined && val !== null) {
          inp.value = val;
          if (val === 0) { inp.style.borderColor = '#e05555'; inp.style.color = '#e05555'; }
        }
      });
    }
    
    // Preview de im√°genes adicionales
    if (p.imagenes && p.imagenes.length > 1) {
      extraImgUrls = p.imagenes.slice(1);
      document.getElementById('fImagenes').value = extraImgUrls.join(', ');
      renderExtraImgs(extraImgUrls);
    }
  } else {
    // Limpiar
    ['fNombre','fPrecio','fPrecioAnt','fSub','fImg','fDesc','fImagenes','fStock'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('fCat').value = 'hombre';
    document.getElementById('fActivo').checked = true;
    document.getElementById('fDestacado').checked = false;
    document.getElementById('fOutlet').checked = false;
    
    document.querySelectorAll('#sizesContainer input, #colorsContainer .color-chip').forEach(el => {
      if (el.tagName === 'INPUT') el.checked = false;
      else el.classList.remove('selected');
    });
  }
  updActivoLabel();
  document.getElementById('mProd').classList.add('open');
  setTimeout(() => document.getElementById('fNombre').focus(), 100);
}

function closeModal() { 
  document.getElementById('mProd').classList.remove('open'); 
  editId = null; 
}

function updateStockLabel() {
  const val = parseInt(document.getElementById('fStock').value);
  const badge = document.getElementById('stockStatusBadge');
  if (isNaN(val) || document.getElementById('fStock').value === '') {
    badge.style.display = 'none';
    return;
  }
  badge.style.display = 'block';
  if (val === 0) {
    badge.textContent = '‚ö†Ô∏è Sin stock';
    badge.style.background = 'rgba(192,57,43,.1)';
    badge.style.color = 'var(--red)';
    badge.style.border = '1px solid rgba(192,57,43,.2)';
  } else if (val <= 5) {
    badge.textContent = `‚ö° Stock bajo (${val})`;
    badge.style.background = 'rgba(230,126,34,.1)';
    badge.style.color = '#c0570e';
    badge.style.border = '1px solid rgba(230,126,34,.2)';
  } else {
    badge.textContent = `‚úì En stock (${val})`;
    badge.style.background = 'rgba(45,138,94,.1)';
    badge.style.color = 'var(--green)';
    badge.style.border = '1px solid rgba(45,138,94,.2)';
  }
}

function updActivoLabel() {
  const on = document.getElementById('fActivo').checked;
  const lbl = document.getElementById('activoLbl');
  lbl.textContent = on ? 'S√≠, se muestra en la tienda' : 'No, est√° oculto';
  lbl.style.color = on ? 'var(--green)' : 'var(--muted)';
}

function previewImg() {
  // legacy - no-op, kept for compat
}

function showImagesPreview(urls) {
  // legacy - rebuild extra imgs grid
  renderExtraImgs(urls);
}

function removeImage(index) {
  extraImgUrls.splice(index, 1);
  document.getElementById('fImagenes').value = extraImgUrls.join(', ');
  renderExtraImgs(extraImgUrls);
}

/* ‚îÄ‚îÄ‚îÄ UPLOADER ‚îÄ‚îÄ‚îÄ */
let extraImgUrls = [];

function abrirSelectorFoto() {
  setTimeout(function() {
    const input = document.getElementById('fileInput');
    input.value = '';
    input.click();
  }, 50);
}

function abrirSelectorFotoExtra() {
  setTimeout(function() {
    const input = document.getElementById('extraFileInput');
    input.value = '';
    input.click();
  }, 50);
}

function onDragOver(e) {
  e.preventDefault();
  document.getElementById('dropZone').classList.add('drag-over');
}
function onDragLeave() {
  document.getElementById('dropZone').classList.remove('drag-over');
}
function onDrop(e) {
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) subirImagen(file, true);
}
function onFileSelect(e) {
  const file = e.target.files[0];
  if (file) subirImagen(file, true);
  e.target.value = '';
}

/* ‚îÄ‚îÄ‚îÄ SUBIR IMAGEN A IMGBB ‚îÄ‚îÄ‚îÄ */
const IMGBB_KEY = 'ba5e9f7a2a99a96d1862a0561896c870';

async function subirImagen(file, isMain) {
  if (file.size > 10 * 1024 * 1024) {
    toast('La imagen no debe superar 10MB', 'err');
    return;
  }

  // Mostrar preview local inmediato mientras sube
  const localUrl = URL.createObjectURL(file);
  if (isMain) {
    setMainImageLoading(localUrl);
  } else {
    addExtraImageLoading(localUrl);
  }

  // Subir a ImgBB
  const formData = new FormData();
  formData.append('image', file);

  try {
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error?.message || 'Error al subir');

    const url = data.data.url;
    if (isMain) {
      setMainImage(url);
    } else {
      replaceExtraImageLoading(localUrl, url);
    }
    URL.revokeObjectURL(localUrl);

  } catch (err) {
    toast('No se pudo subir la imagen: ' + err.message, 'err');
    if (isMain) clearImage();
    else removeExtraImageLoading(localUrl);
    URL.revokeObjectURL(localUrl);
  }
}

function setMainImageLoading(previewSrc) {
  const img = document.getElementById('imgPrev');
  img.src = previewSrc;
  img.style.opacity = '0.5';
  document.getElementById('fImg').value = '';
  document.getElementById('fileInput').style.zIndex = '1'; // behind preview buttons
  document.getElementById('uploadIdle').style.display = 'none';
  document.getElementById('uploadPreview').style.display = 'block';
  document.getElementById('dropZone').classList.add('has-image');
  const badge = document.getElementById('uploadBadge');
  if (badge) { badge.innerHTML = '<div class="spinner" style="width:12px;height:12px;border-color:rgba(255,255,255,.3);border-top-color:#fff"></div> Subiendo imagen...'; badge.style.background = 'var(--accent)'; }
}

function setMainImage(src) {
  const img = document.getElementById('imgPrev');
  img.src = src;
  img.style.opacity = '1';
  document.getElementById('fImg').value = src;
  document.getElementById('fileInput').style.zIndex = '1';
  document.getElementById('uploadIdle').style.display = 'none';
  document.getElementById('uploadPreview').style.display = 'block';
  document.getElementById('dropZone').classList.add('has-image');
  const badge = document.getElementById('uploadBadge');
  if (badge) { badge.innerHTML = '<i class="fas fa-check"></i> Imagen cargada'; badge.style.background = 'var(--green)'; }
}

function clearImage(e) {
  if (e) e.stopPropagation();
  document.getElementById('imgPrev').src = '';
  document.getElementById('imgPrev').style.opacity = '1';
  document.getElementById('fImg').value = '';
  document.getElementById('fileInput').style.zIndex = '10'; // back on top
  document.getElementById('uploadIdle').style.display = 'block';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('dropZone').classList.remove('has-image');
}

function useUrlImage() {
  const url = document.getElementById('fImgUrl').value.trim();
  if (!url) return;
  setMainImage(url);
  document.getElementById('fImgUrl').value = '';
  document.getElementById('urlFallback').removeAttribute('open');
}

function onExtraFiles(e) {
  const files = Array.from(e.target.files);
  files.forEach(f => subirImagen(f, false));
  e.target.value = '';
}

function addExtraImageLoading(previewSrc) {
  extraImgUrls.push('__loading__' + previewSrc);
  renderExtraImgs(extraImgUrls);
}

function replaceExtraImageLoading(previewSrc, realUrl) {
  const idx = extraImgUrls.findIndex(u => u === '__loading__' + previewSrc);
  if (idx !== -1) extraImgUrls[idx] = realUrl;
  document.getElementById('fImagenes').value = extraImgUrls.filter(u => !u.startsWith('__loading__')).join(', ');
  renderExtraImgs(extraImgUrls);
}

function removeExtraImageLoading(previewSrc) {
  extraImgUrls = extraImgUrls.filter(u => u !== '__loading__' + previewSrc);
  renderExtraImgs(extraImgUrls);
}

function addExtraImage(src) {
  extraImgUrls.push(src);
  document.getElementById('fImagenes').value = extraImgUrls.join(', ');
  renderExtraImgs(extraImgUrls);
}

function renderExtraImgs(urls) {
  const grid = document.getElementById('extraImgsGrid');
  grid.innerHTML = '';
  urls.forEach((url, i) => {
    const isLoading = url.startsWith('__loading__');
    const src = isLoading ? url.replace('__loading__', '') : url;
    const div = document.createElement('div');
    div.className = 'extra-img-item';
    div.style.opacity = isLoading ? '0.5' : '1';
    div.innerHTML = `<img src="${src}" alt=""/>` +
      (isLoading
        ? `<div style="position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.3)"><div class="spinner" style="border-color:rgba(255,255,255,.3);border-top-color:#fff;width:20px;height:20px"></div></div>`
        : `<button class="extra-img-remove" onclick="removeImage(${i})" title="Quitar"><i class="fas fa-times"></i></button>`);
    grid.appendChild(div);
  });
  const add = document.createElement('div');
  add.className = 'extra-add-btn';
  add.onclick = abrirSelectorFotoExtra;
  add.innerHTML = '<i class="fas fa-plus"></i><span>Agregar</span>';
  grid.appendChild(add);
}

function renderExtraImgs(urls) {
  const grid = document.getElementById('extraImgsGrid');
  grid.innerHTML = '';
  urls.forEach((url, i) => {
    const div = document.createElement('div');
    div.className = 'extra-img-item';
    div.innerHTML = `<img src="${url}" alt=""/><button class="extra-img-remove" onclick="removeImage(${i})" title="Quitar"><i class="fas fa-times"></i></button>`;
    grid.appendChild(div);
  });
  // Add button always last
  const add = document.createElement('div');
  add.className = 'extra-add-btn';
  add.onclick = abrirSelectorFotoExtra;
  add.innerHTML = '<i class="fas fa-plus"></i><span>Agregar</span>';
  grid.appendChild(add);
}

function addCustomSize() {
  const val = document.getElementById('customSize').value.trim();
  if (!val) return;
  const chip = document.createElement('div');
  chip.className = 'size-chip';
  chip.innerHTML = `<input type="checkbox" value="${val}" checked> <span>${val}</span>`;
  chip.querySelector('input').addEventListener('change', buildStockGrid);
  document.getElementById('sizesContainer').appendChild(chip);
  document.getElementById('customSize').value = '';
  buildStockGrid();
}

/* ‚îÄ‚îÄ‚îÄ GRILLA DE STOCK ‚îÄ‚îÄ‚îÄ */
function buildStockGrid() {
  // Talles seleccionados
  const talles = [];
  document.querySelectorAll('#sizesContainer input[type="checkbox"]:checked').forEach(chk => {
    talles.push(chk.value);
  });

  // Colores seleccionados
  const colores = [];
  document.querySelectorAll('#colorsContainer .color-chip-wrap.selected-wrap').forEach(wrap => {
    colores.push({ nombre: wrap.dataset.color, codigo: wrap.dataset.code });
  });

  const section = document.getElementById('stockGridSection');
  const wrap = document.getElementById('stockGridWrap');
  const tallesSection = document.getElementById('stockTallesSection');
  const tallesWrap = document.getElementById('stockTallesWrap');

  // Stock por talle (sin colores): mostrar cuando hay talles seleccionados
  if (talles.length && !colores.length) {
    tallesSection.style.display = 'block';
    // Guardar valores actuales
    const prevTalles = {};
    tallesWrap.querySelectorAll('.stock-talle-input').forEach(inp => {
      prevTalles[inp.dataset.talle] = inp.value;
    });
    tallesWrap.innerHTML = '';
    talles.forEach(t => {
      const div = document.createElement('div');
      div.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;min-width:70px;';
      const label = document.createElement('span');
      label.style.cssText = 'font-size:12px;font-weight:600;color:var(--text);';
      label.textContent = t;
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.min = '0';
      inp.placeholder = '0';
      inp.value = prevTalles[t] ?? '';
      inp.className = 'stock-input stock-talle-input';
      inp.dataset.talle = t;
      inp.style.cssText = 'width:52px;padding:4px 6px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:13px;font-family:var(--sans);text-align:center;';
      inp.addEventListener('input', () => {
        inp.style.borderColor = (inp.value === '0' || inp.value === '') ? '#e05555' : 'var(--border)';
        inp.style.color = (inp.value === '0' || inp.value === '') ? '#e05555' : 'var(--text)';
      });
      div.appendChild(label);
      div.appendChild(inp);
      tallesWrap.appendChild(div);
    });
  } else {
    tallesSection.style.display = 'none';
  }

  if (!talles.length || !colores.length) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';

  // Guardar valores actuales antes de redibujar
  const prev = getStockData();

  let html = '<table class="stock-table"><thead><tr>';
  html += '<th style="text-align:left;background:var(--bg2);border:1px solid var(--border);padding:7px 10px;">Color \\ Talle</th>';
  talles.forEach(t => { html += `<th>${t}</th>`; });
  html += '<th style="color:var(--accent);">Total</th></tr></thead><tbody>';

  colores.forEach(c => {
    const isLight = parseInt(c.codigo.slice(1,3),16) > 200 && parseInt(c.codigo.slice(3,5),16) > 200 && parseInt(c.codigo.slice(5,7),16) > 200;
    html += `<tr>
      <td style="display:flex;align-items:center;gap:6px;padding:7px 10px;">
        <span class="stock-dot" style="background:${c.codigo};${isLight?'border-color:rgba(0,0,0,.25)':''}"></span>
        ${c.nombre}
      </td>`;
    let rowTotal = 0;
    talles.forEach(t => {
      const key = `${c.nombre}__${t}`;
      const val = prev[key] ?? '';
      if (val) rowTotal += parseInt(val) || 0;
      html += `<td><input type="number" min="0" class="stock-input${val===0||val==='0'?' sin-stock':''}" 
        data-color="${c.nombre}" data-talle="${t}" value="${val}" placeholder="0"
        oninput="updateStockTotal(this)"/></td>`;
    });
    html += `<td><span class="stock-total-badge" id="total-${c.nombre.replace(/\s/g,'_')}">${rowTotal || '-'}</span></td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;

  // Actualizar totales en tiempo real
  wrap.querySelectorAll('.stock-input').forEach(inp => {
    inp.addEventListener('input', () => {
      inp.classList.toggle('sin-stock', inp.value === '0' || inp.value === '');
    });
  });
}

function updateStockTotal(inp) {
  const color = inp.dataset.color;
  const id = 'total-' + color.replace(/\s/g,'_');
  const total = Array.from(document.querySelectorAll(`.stock-input[data-color="${color}"]`))
    .reduce((s, i) => s + (parseInt(i.value) || 0), 0);
  const badge = document.getElementById(id);
  if (badge) badge.textContent = total || '-';
  inp.classList.toggle('sin-stock', inp.value === '0' || inp.value === '');
}

function getStockData() {
  const data = {};
  document.querySelectorAll('.stock-input').forEach(inp => {
    if (inp.dataset.color && inp.dataset.talle) {
      data[`${inp.dataset.color}__${inp.dataset.talle}`] = inp.value !== '' ? parseInt(inp.value) : null;
    }
  });
  return data;
}

function loadStockData(stockMap) {
  if (!stockMap) return;
  document.querySelectorAll('.stock-input').forEach(inp => {
    const key = `${inp.dataset.color}__${inp.dataset.talle}`;
    if (stockMap[key] !== undefined && stockMap[key] !== null) {
      inp.value = stockMap[key];
      inp.classList.toggle('sin-stock', stockMap[key] === 0);
    }
  });
  // Actualizar totales
  const colores = new Set(document.querySelectorAll('.stock-input').map ? 
    Array.from(document.querySelectorAll('.stock-input')).map(i => i.dataset.color) : []);
  colores.forEach(c => {
    const inp = document.querySelector(`.stock-input[data-color="${c}"]`);
    if (inp) updateStockTotal(inp);
  });
}

/* ‚îÄ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ‚îÄ */
let cpHue = 0, cpS = 80, cpV = 80;

function cpInit() {
  const gradient = document.getElementById('cpGradient');
  const hueSlider = document.getElementById('cpHue');
  const hexInput = document.getElementById('cpHex');

  function updateAll() {
    // Update gradient background hue
    gradient.style.background = `
      linear-gradient(to bottom, transparent, #000),
      linear-gradient(to right, #fff, hsl(${cpHue},100%,50%))
    `;
    const color = hsvToHex(cpHue, cpS, cpV);
    document.getElementById('cpPreview').style.background = color;
    document.getElementById('cpCursor').style.background = color;
    hexInput.value = color;
  }

  // Hue slider
  hueSlider.addEventListener('input', () => {
    cpHue = parseInt(hueSlider.value);
    updateAll();
  });

  // Gradient drag
  let dragging = false;
  function pickFromGradient(e) {
    const rect = gradient.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    cpS = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
    cpV = Math.max(0, Math.min(100, (1 - (clientY - rect.top) / rect.height) * 100));
    const cursor = document.getElementById('cpCursor');
    cursor.style.left = cpS + '%';
    cursor.style.top = (100 - cpV) + '%';
    updateAll();
  }
  gradient.addEventListener('mousedown', e => { dragging = true; pickFromGradient(e); });
  gradient.addEventListener('touchstart', e => { dragging = true; pickFromGradient(e); }, {passive:true});
  document.addEventListener('mousemove', e => { if (dragging) pickFromGradient(e); });
  document.addEventListener('touchmove', e => { if (dragging) pickFromGradient(e); }, {passive:true});
  document.addEventListener('mouseup', () => dragging = false);
  document.addEventListener('touchend', () => dragging = false);

  // Hex input
  hexInput.addEventListener('input', () => {
    const hex = hexInput.value.replace(/[^0-9a-fA-F#]/g,'');
    if (hex.length === 7) {
      const [h,s,v] = hexToHsv(hex);
      cpHue = h; cpS = s; cpV = v;
      hueSlider.value = cpHue;
      document.getElementById('cpCursor').style.left = cpS + '%';
      document.getElementById('cpCursor').style.top = (100-cpV) + '%';
      document.getElementById('cpPreview').style.background = hex;
    }
  });

  updateAll();
}

function hsvToHex(h, s, v) {
  s /= 100; v /= 100;
  const f = n => {
    const k = (n + h/60) % 6;
    return v - v*s*Math.max(0, Math.min(k, 4-k, 1));
  };
  const toHex = x => Math.round(x*255).toString(16).padStart(2,'0');
  return '#' + toHex(f(5)) + toHex(f(3)) + toHex(f(1));
}

function hexToHsv(hex) {
  let r = parseInt(hex.slice(1,3),16)/255;
  let g = parseInt(hex.slice(3,5),16)/255;
  let b = parseInt(hex.slice(5,7),16)/255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min;
  let h = 0, s = max ? d/max : 0, v = max;
  if (d) {
    if (max===r) h = ((g-b)/d+6)%6;
    else if (max===g) h = (b-r)/d+2;
    else h = (r-g)/d+4;
    h *= 60;
  }
  return [Math.round(h), Math.round(s*100), Math.round(v*100)];
}

function cpAddColor() {
  const hex = document.getElementById('cpHex').value.trim();
  const name = document.getElementById('cpName').value.trim() || hex;
  if (!hex || !/^#[0-9a-fA-F]{6}$/.test(hex)) {
    toast('Ingres√° un color v√°lido', 'err'); return;
  }
  // Check not duplicate
  if (document.querySelector(`#colorsContainer .color-chip-wrap[data-color="${name}"]`)) {
    toast('Ese color ya est√° agregado', 'err'); return;
  }
  addColorChip(name, hex, true, 0);
  document.getElementById('cpName').value = '';
  buildStockGrid(); // ‚Üê actualiza la grilla de stock autom√°ticamente
  toast(`Color "${name}" agregado ‚úì`);
}

function addColorChip(name, code, selected = false, stock = null) {
  const container = document.getElementById('colorsContainer');
  const wrap = document.createElement('div');
  wrap.className = 'color-chip-wrap' + (selected ? ' selected-wrap' : '');
  wrap.dataset.color = name;
  wrap.dataset.code = code;

  const chip = document.createElement('div');
  chip.className = 'color-chip' + (selected ? ' selected' : '');
  chip.style.backgroundColor = code;
  const isLight = ['#FFFFFF','#F5F0E8','#FDD835','#81D4FA','#CE93D8','#F48FB1'].includes(code)
    || (parseInt(code.slice(1,3),16) > 200 && parseInt(code.slice(3,5),16) > 200 && parseInt(code.slice(5,7),16) > 200);
  if (isLight) chip.style.borderColor = 'rgba(0,0,0,.2)';

  const label = document.createElement('div');
  label.className = 'color-chip-label';
  label.textContent = name;

  const stockWrap = document.createElement('div');
  stockWrap.className = 'color-stock-wrap';
  const stockInput = document.createElement('input');
  stockInput.type = 'number';
  stockInput.min = '0';
  stockInput.placeholder = '0';
  stockInput.value = stock !== null && stock !== undefined ? stock : '';
  stockInput.className = 'color-stock-input';
  stockInput.title = 'Stock de este color';
  stockInput.onclick = e => e.stopPropagation();
  stockInput.addEventListener('input', () => {
    stockInput.classList.toggle('sin-stock', stockInput.value === '0');
  });
  // Inicializar estado
  if (stock !== null && stock !== undefined && stock !== '') {
    stockInput.classList.toggle('sin-stock', parseInt(stock) === 0);
  }
  stockWrap.appendChild(stockInput);

  const removeBtn = document.createElement('button');
  removeBtn.className = 'cp-chip-remove';
  removeBtn.innerHTML = '√ó';
  removeBtn.title = 'Quitar';
  removeBtn.onclick = e => { e.stopPropagation(); wrap.remove(); };

  wrap.appendChild(chip);
  wrap.appendChild(label);
  wrap.appendChild(stockWrap);
  wrap.appendChild(removeBtn);

  wrap.onclick = () => {
    const sel = wrap.classList.toggle('selected-wrap');
    chip.classList.toggle('selected', sel);
    buildStockGrid();
  };
  container.appendChild(wrap);
}

function addCustomColor() {}

function updateSubcategorias() {
  const cat = document.getElementById('fCat').value;
  const subSelect = document.getElementById('fSub');
  const options = {
    hombre: ['Camperas', 'Remeras', 'Camisas', 'Musculosa', 'Pantalones', 'Buzos', 'Sweaters', 'Conjuntos', 'Bermudas', 'Shorts'],
    mujer: [
      'Remeras', 'Tops', 'Bodies', 'Camisola', 'T√∫nicas', 'Musculosa',
      'Pantalones', 'Calzas', 'Leggings', 'Joggings',
      'Polleras', 'Vestidos', 'Monos', 'Mameluco',
      'Camperas', 'Blazers', 'Cardigans', 'Buzos', 'Sweaters',
      'Shorts', 'Bermudas', 'Conjuntos', 'Lencer√≠a / Ropa interior'
    ],
    accesorios: ['Abanicos', 'Gorras', 'Cintos', 'Pilusos', 'Lentes de sol', 'Bijouterie hombre', 'Bijouterie mujer', 'Billeteras', 'Ri√±oneras', 'Medias', 'Boxers', 'Zapatillas'],
    new: ['Camperas', 'Remeras', 'Pantalones', 'Vestidos', 'Conjuntos', 'Tops', 'Buzos', 'Accesorios']
  };
  
  subSelect.innerHTML = '<option value="">Seleccionar</option>';
  (options[cat] || []).forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    subSelect.appendChild(option);
  });
}

function saveProduct() {
  const nombre = document.getElementById('fNombre').value.trim();
  const precio = parseInt(document.getElementById('fPrecio').value);
  const imagen = document.getElementById('fImg').value.trim();
  
  if (!nombre) { toast('Ingres√° el nombre del producto','err'); return; }
  if (!precio||precio<1) { toast('Ingres√° un precio v√°lido','err'); return; }
  if (!imagen) { toast('Carg√° una imagen del producto','err'); return; }

  const ant = parseInt(document.getElementById('fPrecioAnt').value);
  const imagenesExtras = extraImgUrls.filter(u => u && u !== imagen);
  
  // Recolectar talles seleccionados
  const talles = [];
  document.querySelectorAll('#sizesContainer input[type="checkbox"]:checked').forEach(chk => {
    talles.push(chk.value);
  });
  
  // Recolectar colores seleccionados con stock
  const colores = [];
  document.querySelectorAll('#colorsContainer .color-chip-wrap.selected-wrap').forEach(wrap => {
    const stockInput = wrap.querySelector('.color-stock-input');
    const stock = stockInput ? (parseInt(stockInput.value) || 0) : 0;
    colores.push({ nombre: wrap.dataset.color, codigo: wrap.dataset.code, stock });
  });

  // Recolectar stock por talle
  const stockTalles = {};
  document.querySelectorAll('.stock-talle-input').forEach(inp => {
    if (inp.dataset.talle) stockTalles[inp.dataset.talle] = inp.value !== '' ? parseInt(inp.value) : null;
  });

  const prod = {
    id: editId || nombre.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') + '-' + Date.now(),
    nombre, 
    precio,
    precioAnterior: (ant && ant > precio) ? ant : null,
    categoria: document.getElementById('fCat').value,
    subcategoria: document.getElementById('fSub').value.trim(),
    descripcion: document.getElementById('fDesc').value.trim(),
    imagen,
    imagenes: [imagen, ...imagenesExtras],
    tallesDisponibles: talles,
    colores: colores,
    activo: document.getElementById('fActivo').checked,
    destacado: document.getElementById('fDestacado').checked,
    outlet: document.getElementById('fOutlet').checked,
    stockMap: getStockData(),
    stockTalles: Object.keys(stockTalles).length ? stockTalles : null,
    stock: (() => {
      // Si el campo manual tiene valor, usar ese
      const raw = document.getElementById('fStock').value.trim();
      if (raw !== '') return parseInt(raw);
      // Calcular desde stockMap (color√ótalle)
      const sm = getStockData();
      const smVals = Object.values(sm).filter(v => v !== null && v !== undefined && v !== '');
      if (smVals.length) return smVals.reduce((a, b) => a + (parseInt(b) || 0), 0);
      // Calcular desde stockTalles
      const stVals = Object.values(stockTalles).filter(v => v !== null && v !== undefined);
      if (stVals.length) return stVals.reduce((a, b) => a + (parseInt(b) || 0), 0);
      // Calcular desde colores con stock
      const colTotal = colores.reduce((a, c) => a + (parseInt(c.stock) || 0), 0);
      if (colTotal > 0) return colTotal;
      return null; // sin info de stock = no marcar agotado en tienda
    })(),
    sku: document.getElementById('fSku')?.value.trim() || (editId ? products.find(p => p.id === editId)?.sku : (nombre.toUpperCase().replace(/ /g,'-'))),
    marca: document.getElementById('fMarca')?.value.trim() || null,
    // New fields
    tags: productTags.length ? [...productTags] : null,
    fabrica: getFabricData(),
    cuidados: document.getElementById('fCuidados')?.value || null,
    temporada: document.getElementById('fTemporada')?.value || null,
    genero: document.getElementById('fGenero')?.value || null,
    peso: document.getElementById('fPeso')?.value ? parseInt(document.getElementById('fPeso').value) : null,
    origen: document.getElementById('fOrigen')?.value || null,
    proveedor: document.getElementById('fProveedor')?.value.trim() || null,
    notas: document.getElementById('fNotas')?.value.trim() || null,
    costo: document.getElementById('fCosto')?.value ? parseInt(document.getElementById('fCosto').value) : null,
    link: document.getElementById('fLink')?.value.trim() || null,
  };

  if (editId) {
    const idx = products.findIndex(x => x.id === editId);
    if (idx !== -1) products[idx] = prod;
  } else {
    products.unshift(prod);
  }
  closeModal();
  dirty();
  renderGrid();
  updateStats();

  // Auto-publicar si hay token
  const token = localStorage.getItem('bc_gh_token');
  if (token) {
    setTimeout(() => publish(), 300);
  } else {
    toast('Guardado localmente. Configur√° el token de GitHub para publicar.', 'info');
  }
}

/* ‚îÄ‚îÄ‚îÄ DUPLICAR ‚îÄ‚îÄ‚îÄ */
function duplicateProduct(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  
  const nuevo = {
    ...p,
    id: p.nombre.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '-' + Date.now(),
    nombre: p.nombre + ' (copia)',
    activo: false
  };
  products.unshift(nuevo);
  dirty(); renderGrid(); updateStats();
  toast('Producto duplicado');
}

function duplicateFromModal() {
  if (editId) duplicateProduct(editId);
  closeModal();
}

/* ‚îÄ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ */
function deleteP(id) {
  const p = products.find(x => x.id === id);
  if (!p || !confirm(`¬øEliminar "${p.nombre}"?`)) return;
  products = products.filter(x => x.id !== id);
  dirty(); renderGrid(); updateStats(); 
  toast('Producto eliminado');
}

/* ‚îÄ‚îÄ‚îÄ DIRTY / BANNER ‚îÄ‚îÄ‚îÄ */
function dirty() {
  pending++;
  const b = document.getElementById('saveBanner');
  b.classList.add('show');
  document.getElementById('bannerCount').textContent = pending === 1 ? '1 cambio' : `${pending} cambios`;
  localStorage.setItem('bc_draft', JSON.stringify(products));
}

/* ‚îÄ‚îÄ‚îÄ EXPORT/IMPORT ‚îÄ‚îÄ‚îÄ */
function exportCSV() {
  const csv = ['nombre,precio,precioAnterior,categoria,subcategoria,activo,descripcion,talles,colores,imagen'];
  products.forEach(p => {
    const talles = (p.tallesDisponibles || []).join('|');
    const colores = (p.colores || []).join('|');
    csv.push(`"${p.nombre}",${p.precio},${p.precioAnterior||''},${p.categoria},${p.subcategoria||''},${p.activo},"${p.descripcion||''}","${talles}","${colores}",${p.imagen}`);
  });
  
  const blob = new Blob([csv.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'productos_export.csv';
  a.click();
  toast('Exportado a CSV');
}

function importFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    const text = ev.target.result;
    if (file.name.endsWith('.json')) {
      try {
        const nuevos = JSON.parse(text);
        products = nuevos;
        toast('Importado desde JSON');
      } catch(e) { toast('Error en JSON','err'); }
    } else {
      // CSV
      const lines = text.split('\n');
      const headers = lines[0].split(',');
      const nuevos = [];
      
      for (let i=1; i<lines.length; i++) {
        if (!lines[i].trim()) continue;
        const vals = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
        if (vals.length < 3) continue;
        
        const p = {
          nombre: vals[0]?.replace(/"/g,'') || '',
          precio: parseInt(vals[1]) || 0,
          precioAnterior: parseInt(vals[2]) || null,
          categoria: vals[3]?.replace(/"/g,'') || 'hombre',
          subcategoria: vals[4]?.replace(/"/g,''),
          activo: vals[5] === 'true',
          descripcion: vals[6]?.replace(/"/g,''),
          tallesDisponibles: vals[7]?.replace(/"/g,'').split('|').filter(s=>s),
          colores: vals[8]?.replace(/"/g,'').split('|').filter(s=>s),
          imagen: vals[9]?.replace(/"/g,'') || '',
          id: 'import-' + Date.now() + '-' + i
        };
        nuevos.push(p);
      }
      products = nuevos;
      toast(`Importados ${nuevos.length} productos`);
    }
    dirty(); renderGrid(); updateStats();
  };
  reader.readAsText(file);
  e.target.value = '';
}

/* ‚îÄ‚îÄ‚îÄ PUBLICAR EN GITHUB ‚îÄ‚îÄ‚îÄ */
async function publish() {
  const token = localStorage.getItem('bc_gh_token');
  const repo  = localStorage.getItem('bc_gh_repo') || 'bara-and-co/Bara-Co';
  if (!token) { openConfig(); toast('Primero configur√° tu token de GitHub','err'); return; }

  const btn = document.getElementById('publishBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Publicando...';

  try {
    // Verificar que no haya im√°genes base64 sin subir
    const conBase64 = products.filter(p => p.imagen && p.imagen.startsWith('data:'));
    if (conBase64.length) {
      toast(`‚ö†Ô∏è ${conBase64.length} producto(s) tienen imagen sin subir. Edit√°los y volv√© a cargar la foto.`, 'err');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publicar ahora';
      return;
    }

    const getR = await fetch(`https://api.github.com/repos/${repo}/contents/productos.json`, {
      headers:{ Authorization:`token ${token}`, Accept:'application/vnd.github.v3+json' }
    });

    if (!getR.ok && getR.status !== 404) {
      if (getR.status === 401) throw new Error('Token vencido. Gener√° uno nuevo en GitHub ‚Üí Settings ‚Üí Developer settings.');
      if (getR.status === 403) throw new Error('Sin permisos. El token necesita el permiso "repo".');
      throw new Error(`Error ${getR.status} al acceder al repositorio.`);
    }

    const sha = getR.ok ? (await getR.json()).sha : null;
    const json = JSON.stringify(products, null, 2);
    const b64  = btoa(unescape(encodeURIComponent(json)));
    const now  = new Date().toLocaleString('es-AR');

    const putR = await fetch(`https://api.github.com/repos/${repo}/contents/productos.json`, {
      method:'PUT',
      headers:{ Authorization:`token ${token}`, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
      body: JSON.stringify({ message:`Admin: actualizar productos ‚Äî ${now}`, content:b64, ...(sha?{sha}:{}) })
    });

    if (!putR.ok) {
      const e = await putR.json();
      if (putR.status === 422) throw new Error('Archivo demasiado grande. Revis√° que las im√°genes sean URLs, no archivos.');
      throw new Error(e.message || `Error ${putR.status} al publicar`);
    }

    pending = 0;
    document.getElementById('saveBanner').classList.remove('show');
    localStorage.removeItem('bc_draft');
    toast('¬°Publicado! La tienda se actualiza en ~1 minuto üéâ','ok');

  } catch(e) {
    toast('Error: ' + e.message, 'err');
    console.error('Publish error:', e);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publicar ahora';
  }
}

/* ‚îÄ‚îÄ‚îÄ CONFIGURACI√ìN ‚îÄ‚îÄ‚îÄ */
function openConfig() { 
  document.getElementById('cfgOk').classList.remove('on'); 
  document.getElementById('cfgErr').classList.remove('on'); 
  document.getElementById('mCfg').classList.add('open'); 
}

function closeConfig(e) { 
  if(e && e.target !== document.getElementById('mCfg')) return; 
  document.getElementById('mCfg').classList.remove('open'); 
}

function saveConfig() {
  const t = document.getElementById('cfgToken').value.trim();
  const r = document.getElementById('cfgRepo').value.trim();
  if (!t||!r) { 
    document.getElementById('cfgErr').textContent='Complet√° el token y el repositorio'; 
    document.getElementById('cfgErr').classList.add('on'); 
    return; 
  }
  localStorage.setItem('bc_gh_token', t);
  localStorage.setItem('bc_gh_repo', r);
  document.getElementById('cfgOk').classList.add('on');
  document.getElementById('cfgErr').classList.remove('on');
}

/* ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ */
function onBd(e, id, fn) { if(e.target===document.getElementById(id)) fn(); }

let toastTmr;
function toast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.innerHTML = msg; 
  el.className = `toast show ${type}`;
  clearTimeout(toastTmr); 
  toastTmr = setTimeout(() => el.classList.remove('show'), 3500);
}

/* ‚îÄ‚îÄ‚îÄ TAB SWITCHER ‚îÄ‚îÄ‚îÄ */
function switchTab(btn, panelId) {
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(panelId).classList.add('active');
}

/* ‚îÄ‚îÄ‚îÄ SORT ‚îÄ‚îÄ‚îÄ */
let sortMode = 'recent';
function setSort(btn, mode) {
  sortMode = mode;
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderGrid();
}

/* ‚îÄ‚îÄ‚îÄ SELECTION MODE ‚îÄ‚îÄ‚îÄ */
let selectedIds = new Set();

function toggleSelectCard(id, checked) {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  const count = selectedIds.size;
  if (count > 0) {
    bar.classList.add('show');
    document.getElementById('bulkCount').textContent = count;
  } else {
    bar.classList.remove('show');
  }
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll('.card-select-chk').forEach(c => c.checked = false);
  document.querySelectorAll('.prod-card').forEach(c => c.classList.remove('selected-card'));
  updateBulkBar();
}

function bulkToggleActive(val) {
  selectedIds.forEach(id => {
    const p = products.find(x => x.id === id);
    if (p) p.activo = val;
  });
  dirty(); renderGrid(); updateStats();
  clearSelection();
  toast(`${val ? 'Visibles' : 'Ocultos'}: ${selectedIds.size} productos`);
}

function bulkDelete() {
  if (!confirm(`¬øEliminar ${selectedIds.size} productos?`)) return;
  products = products.filter(p => !selectedIds.has(p.id));
  selectedIds.clear();
  dirty(); renderGrid(); updateStats();
  updateBulkBar();
  toast('Productos eliminados');
}

/* ‚îÄ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ‚îÄ */
let productTags = [];

function addTag(e) {
  if (e.key !== 'Enter' && e.key !== ',') return;
  e.preventDefault();
  const input = document.getElementById('tagInput');
  const val = input.value.trim().replace(/,$/, '');
  if (!val || productTags.includes(val)) { input.value = ''; return; }
  productTags.push(val);
  renderTags();
  input.value = '';
}

function removeTag(tag) {
  productTags = productTags.filter(t => t !== tag);
  renderTags();
}

function renderTags() {
  const wrap = document.getElementById('tagWrap');
  const input = document.getElementById('tagInput');
  wrap.querySelectorAll('.tag-chip').forEach(c => c.remove());
  productTags.forEach(tag => {
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.innerHTML = `${tag}<button onclick="removeTag('${tag}')">‚úï</button>`;
    wrap.insertBefore(chip, input);
  });
}

/* ‚îÄ‚îÄ‚îÄ FABRIC COMPOSITION ‚îÄ‚îÄ‚îÄ */
// ‚îÄ‚îÄ Lista completa de todas las fibras/tejidos por categor√≠a ‚îÄ‚îÄ
const FABRIC_GROUPS = [
  { id:'vegetal', label:'üåø Naturales vegetales', sum:'fgs-vegetal', color:'#c9a96e',
    items:['algodon','lino','ramio','canhamo','yute','bambu'] },
  { id:'animal',  label:'üêë Naturales animales',  sum:'fgs-animal',  color:'#c0392b',
    items:['lana','cashmere','mohair','alpaca','angora','seda','cuero','gamuza'] },
  { id:'sint',    label:'üî¨ Sint√©ticas',           sum:'fgs-sint',    color:'#3d6bce',
    items:['poliester','nylon','acilico','elastano','microfibra','poliuretano'] },
  { id:'artif',   label:'üçÉ Artificiales celulosa',sum:'fgs-artif',   color:'#8e44ad',
    items:['viscosa','modal','lyocell','acetato','triacetato'] },
  { id:'plano',   label:'üßµ Tejidos Planos',       sum:'fgs-plano',   color:'#2c3e50',
    items:['popelin','sarga','gabardina','denim','tafeta','saten','crepe','gasa','organza','batista','oxford','twill','lona','jacquard'] },
  { id:'punto',   label:'üß∂ Tejidos de Punto',     sum:'fgs-punto',   color:'#00b894',
    items:['jersey','interlock','rib','morley','pique','frisa','polar','plush','waffle','ptoroma'] },
  { id:'tec',     label:'‚ö° T√©cnicas/Deportivas',  sum:'fgs-tec',     color:'#0984e3',
    items:['dryfit','supplex','neoprene','softshell','taslan','ripstop','powermesh'] },
  { id:'elegan',  label:'‚ú® Elegantes/Alta Moda',  sum:'fgs-elegan',  color:'#a29bfe',
    items:['tul','encaje','guipur','terciopelo','pana','lurex','mikado','chiffon'] },
  { id:'abrigo',  label:'üß• Abrigos',              sum:'fgs-abrigo',  color:'#636e72',
    items:['pano','tweed','boucle','corderoy','fieltro','micropolar','franela'] },
];
// Array plano de todas las fibras (para las funciones existentes)
const FABRICS = FABRIC_GROUPS.flatMap(g => g.items)
  .filter((f,i,a) => a.indexOf(f) === i); // dedup

const FABRIC_COLORS = {
  // Vegetales
  algodon:'#c9a96e',  lino:'#f39c12',    ramio:'#e2c97e',   canhamo:'#8d9b4a',
  yute:'#a07850',     bambu:'#5d9e6a',
  // Animales
  lana:'#c0392b',     cashmere:'#d4956a', mohair:'#c8a4b8',  alpaca:'#c4a882',
  angora:'#e8d5d5',   seda:'#1abc9c',    cuero:'#8b4513',   gamuza:'#a0775a',
  // Sint√©ticas
  poliester:'#3d6bce',nylon:'#7f8c8d',   acilico:'#e67e22', elastano:'#2d8a5e',
  microfibra:'#5dade2',poliuretano:'#6c7a89',
  // Artificiales
  viscosa:'#8e44ad',  modal:'#34495e',   lyocell:'#1e8449',  acetato:'#9b59b6',
  triacetato:'#7d3c98',
  // Tejidos planos
  popelin:'#00b894',  sarga:'#7d6608',   gabardina:'#fd79a8',denim:'#2c3e50',
  tafeta:'#d5a6d0',   saten:'#f1c40f',   crepe:'#cb4335',    gasa:'#aed6f1',
  organza:'#d7bde2',  batista:'#a9cce3', oxford:'#5d6d7e',   twill:'#797d7f',
  lona:'#808b96',     jacquard:'#884ea0',
  // Tejidos de punto
  jersey:'#27ae60',   interlock:'#148f77',rib:'#1d8348',     morley:'#28b463',
  pique:'#55efc4',    frisa:'#6c5ce7',   polar:'#74b9ff',    plush:'#a29bfe',
  waffle:'#fab1a0',   ptoroma:'#81ecec',
  // T√©cnicas
  dryfit:'#0984e3',   supplex:'#00cec9', neoprene:'#2d3436', softshell:'#0652dd',
  taslan:'#1289a7',   ripstop:'#006266', powermesh:'#12cbc4',
  // Elegantes
  tul:'#a29bfe',      encaje:'#f8d7da',  guipur:'#e8daef',   terciopelo:'#7d3c98',
  pana:'#784212',     lurex:'#d4ac0d',   mikado:'#e8daef',   chiffon:'#f9e4ff',
  // Abrigos
  pano:'#5d6d7e',     tweed:'#6e5b47',   boucle:'#b7b7a4',   corderoy:'#b97a56',
  fieltro:'#808b96',  micropolar:'#6c5ce7',franela:'#e17055',
};

function updateFabric() {
  let total = 0;
  FABRICS.forEach(f => {
    const slider = document.getElementById(`fab-${f}`);
    const pct = document.getElementById(`fab-${f}-pct`);
    if (slider && pct) {
      pct.value = slider.value;
      total += parseInt(slider.value) || 0;
    }
  });
  updateFabricUI(total);
}

function syncFabricSlider(name) {
  const pct = document.getElementById(`fab-${name}-pct`);
  const slider = document.getElementById(`fab-${name}`);
  if (pct && slider) {
    let val = Math.max(0, Math.min(100, parseInt(pct.value) || 0));
    pct.value = val;
    slider.value = val;
  }
  updateFabricTotal();
}

function updateFabricTotal() {
  let total = 0;
  FABRICS.forEach(f => {
    total += parseInt(document.getElementById(`fab-${f}`)?.value) || 0;
  });
  updateFabricUI(total);
}

function updateFabricUI(total) {
  const badge = document.getElementById('fabricTotal');
  if (!badge) return;
  badge.textContent = total + '%';
  badge.className = 'fabric-total-badge ' + (total === 100 ? 'ok' : total > 100 ? 'warn' : 'partial');

  // Visual bar general
  const bar = document.getElementById('fabricBarVisual');
  if (bar) {
    bar.innerHTML = '';
    FABRICS.forEach(f => {
      const val = parseInt(document.getElementById(`fab-${f}`)?.value) || 0;
      if (val > 0) {
        const seg = document.createElement('div');
        seg.className = 'fabric-bar-segment';
        seg.style.width = val + '%';
        seg.style.background = FABRIC_COLORS[f] || '#ccc';
        seg.title = f.charAt(0).toUpperCase() + f.slice(1) + ': ' + val + '%';
        bar.appendChild(seg);
      }
    });
  }

  // Badge por grupo + resaltar filas con valor
  FABRIC_GROUPS.forEach(g => {
    let groupTotal = 0;
    g.items.forEach(f => {
      const val = parseInt(document.getElementById(`fab-${f}`)?.value) || 0;
      groupTotal += val;
      const row = document.querySelector(`.fab-group-row[data-f="${f}"]`);
      if (row) row.classList.toggle('has-val', val > 0);
    });
    const sumEl = document.getElementById(g.sum);
    if (sumEl) {
      if (groupTotal > 0) {
        sumEl.textContent = groupTotal + '%';
        sumEl.classList.remove('empty');
      } else {
        sumEl.textContent = '‚Äî';
        sumEl.classList.add('empty');
      }
    }
  });
}

function toggleFabGroup(summary) {
  // Solo abre/cierra ‚Äî el browser maneja el details nativo
  // Pero hacemos que se abra autom√°ticamente cuando se edita un item del grupo
}

function applyFabricPreset(preset) {
  FABRICS.forEach(f => {
    const slider = document.getElementById(`fab-${f}`);
    const pct = document.getElementById(`fab-${f}-pct`);
    const val = preset[f] || 0;
    if (slider) slider.value = val;
    if (pct) pct.value = val;
  });
  updateFabricTotal();
}

function clearFabric() {
  applyFabricPreset({});
}

function getFabricData() {
  const data = {};
  FABRICS.forEach(f => {
    const val = parseInt(document.getElementById(`fab-${f}`)?.value) || 0;
    if (val > 0) data[f] = val;
  });
  return Object.keys(data).length ? data : null;
}

function loadFabricData(data) {
  if (!data) return;
  FABRICS.forEach(f => {
    const val = data[f] || 0;
    const slider = document.getElementById(`fab-${f}`);
    const pct = document.getElementById(`fab-${f}-pct`);
    if (slider) slider.value = val;
    if (pct) pct.value = val;
  });
  // Auto-abrir grupos que tienen datos
  FABRIC_GROUPS.forEach(g => {
    const hasData = g.items.some(f => (data[f] || 0) > 0);
    if (hasData) {
      const detailsEl = document.querySelector(`#fgs-${g.id}`)?.closest('details');
      if (detailsEl) detailsEl.open = true;
    }
  });
  updateFabricTotal();
}

/* ‚îÄ‚îÄ‚îÄ CARE INSTRUCTIONS ‚îÄ‚îÄ‚îÄ */
function toggleCare(chip) {
  chip.classList.toggle('selected');
  updateCareInput();
}

function updateCareInput() {
  const selected = [];
  document.querySelectorAll('.care-chip.selected').forEach(c => selected.push(c.dataset.care));
  document.getElementById('fCuidados').value = selected.join('|');
}

function loadCareData(str) {
  if (!str) return;
  const items = str.split('|');
  document.querySelectorAll('.care-chip').forEach(chip => {
    chip.classList.toggle('selected', items.includes(chip.dataset.care));
  });
}

/* ‚îÄ‚îÄ‚îÄ MARGEN CALCULATOR ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  const priceInput = document.getElementById('fPrecio');
  const costoInput = document.getElementById('fCosto');
  if (priceInput && costoInput) {
    [priceInput, costoInput].forEach(inp => inp.addEventListener('input', calcMargen));
  }
});

function calcMargen() {
  const precio = parseInt(document.getElementById('fPrecio')?.value) || 0;
  const costo = parseInt(document.getElementById('fCosto')?.value) || 0;
  const badge = document.getElementById('margenBadge');
  if (!badge) return;
  if (!precio || !costo) { badge.style.display = 'none'; return; }
  const margen = Math.round(((precio - costo) / precio) * 100);
  badge.style.display = 'block';
  badge.textContent = `Margen: ${margen}% (ganancia: $${(precio - costo).toLocaleString('es-AR')})`;
  badge.style.background = margen > 30 ? 'rgba(45,138,94,.1)' : 'rgba(201,169,110,.1)';
  badge.style.color = margen > 30 ? 'var(--green)' : 'var(--accent)';
  badge.style.border = margen > 30 ? '1px solid rgba(45,138,94,.2)' : '1px solid rgba(201,169,110,.2)';
}

document.addEventListener('keydown', e => { 
  if(e.key==='Escape'){ 
    closeModal(); 
    document.getElementById('mCfg').classList.remove('open'); 
  }
});

// Verificar autenticaci√≥n al cargar
if (checkAuth()) init();
</script>
</body>
</html>
